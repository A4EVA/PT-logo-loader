<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Auto Convert Go to Dart with an Abstract Syntax Tree</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Auto Convert Go to Dart with an Abstract Syntax Tree" 
    data-rh="true">
<meta property="og:description" 
    content="How we convert Go code to Dart and Flutter automatically with an Abstract Syntax Tree" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/bloc-ios.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Auto Convert Go to Dart with an Abstract Syntax Tree</h1>
    <nav id="TOC"><ul>
<li><a href="#why-auto-convert-go-to-dart">1 Why Auto Convert Go to Dart?</a><ul></ul></li>
<li><a href="#manual-conversion-from-go-to-dart-gets-really-tiring">2 Manual Conversion From Go To Dart Gets Really Tiring</a><ul></ul></li>
<li><a href="#whats-an-abstract-syntax-tree">3 What's an Abstract Syntax Tree?</a><ul></ul></li>
<li><a href="#generate-an-abstract-syntax-tree">4 Generate an Abstract Syntax Tree</a><ul></ul></li>
<li><a href="#walk-the-abstract-syntax-tree">5 Walk the Abstract Syntax Tree</a><ul></ul></li>
<li><a href="#auto-convert-go-type-to-dart">6 Auto Convert Go Type to Dart</a><ul></ul></li>
<li><a href="#auto-convert-go-struct-to-dart">7 Auto Convert Go Struct to Dart</a><ul></ul></li>
<li><a href="#auto-generate-cbor-encoder">8 Auto Generate CBOR Encoder</a><ul></ul></li>
<li><a href="#auto-convert-go-function-to-dart">9 Auto Convert Go Function to Dart</a><ul></ul></li>
<li><a href="#test-auto-conversion">10 Test Auto Conversion</a><ul></ul></li>
<li><a href="#whats-next">11 What's Next</a><ul></ul></li>
<li><a href="#further-reading">12 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/bloc-ios.jpg" alt="Work-in-progress PineTime Companion App on iPhone, converted from Go to Flutter and Dart" /></p>
<p><em>Work-in-progress PineTime Companion App on iPhone, converted from Go to Flutter and Dart</em></p>
<p>TODO</p>
<p>Let's learn how this Go code...</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/image.go"><code>nmxact/nmp/image.go</code></a></p>
<pre><code class="language-go">//  Convert From Go...
//  Go Struct
type ImageUploadReq struct {
  NmpBase  `codec:&quot;-&quot;`
  ImageNum uint8  `codec:&quot;image&quot;`
  Off      uint32 `codec:&quot;off&quot;`
  Len      uint32 `codec:&quot;len,omitempty&quot;`
  DataSha  []byte `codec:&quot;sha,omitempty&quot;`
  Upgrade  bool   `codec:&quot;upgrade,omitempty&quot;`
  Data     []byte `codec:&quot;data&quot;`
}

//  Go Function
func NewImageUploadReq() *ImageUploadReq {
  r := &amp;ImageUploadReq{}
  fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD)
  return r
}
</code></pre>
<p>Was automatically converted to this Dart code...</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/nmp/image.dart"><code>dart/nmp/image.dart</code></a></p>
<pre><code class="language-dart">//  Converted To Dart...
//  Converted Dart Class
class ImageUploadReq 
  with NmpBase       //  Get and set SMP Message Header
  implements NmpReq  //  SMP Request Message
{
  int ImageNum; //  image: uint8
  int Off;      //  off: uint32
  int Len;      //  len: uint32
  typed.Uint8Buffer DataSha;  //  sha: []byte
  bool Upgrade;               //  upgrade: bool
  typed.Uint8Buffer Data;     //  data: []byte

  NmpMsg Msg() { return MsgFromReq(this); }

  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
    builder.writeString(&quot;image&quot;);
    builder.writeInt(ImageNum); // uint8
    //  ...Omitted...
    builder.writeString(&quot;data&quot;);
    builder.writeArray(Data);   // []byte
  }
}

//  Converted Dart Function
ImageUploadReq NewImageUploadReq() {
  var r = ImageUploadReq();
  fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD);
  return r;
}
</code></pre>
<h1 id="why-auto-convert-go-to-dart" class="section-header"><a href="#why-auto-convert-go-to-dart">1 Why Auto Convert Go to Dart?</a></h1>
<p>TODO</p>
<p>Both languages were created at Google, yet so different</p>
<p>Minimise errors in conversion</p>
<p>Huge volume of code</p>
<p>Consistency of conversion</p>
<p>Easy cross reference</p>
<h1 id="manual-conversion-from-go-to-dart-gets-really-tiring" class="section-header"><a href="#manual-conversion-from-go-to-dart-gets-really-tiring">2 Manual Conversion From Go To Dart Gets Really Tiring</a></h1>
<p>Earlier we attempted a manual code conversion from Go to Dart...</p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/companion">&quot;Convert Go to Flutter and Dart for PineTime Companion App&quot;</a></em></p>
<p>But it became really tedious and mechanical...</p>
<ol>
<li>
<p>Add a Semicolon (<code>;</code>) to every line</p>
</li>
<li>
<p>Flip the Names and Types, so this Go code...</p>
<pre><code class="language-go">//  In Go...
Len uint32
</code></pre>
<p>Becomes this code in Dart...</p>
<pre><code class="language-dart">//  In Dart...
int Len;
</code></pre>
</li>
<li>
<p>Functions also need to be flipped from this...</p>
<pre><code class="language-go">//  In Go...
func NewImageUploadReq() *ImageUploadReq { ...
</code></pre>
<p>To this...</p>
<pre><code class="language-dart">//  In Dart...
ImageUploadReq NewImageUploadReq() { ...
</code></pre>
</li>
<li>
<p>It's easy to encode Go Structs into CBOR / JSON...</p>
<pre><code class="language-go">//  In Go...
type ImageUploadReq struct {
  //  Struct Field &quot;Len&quot; will be encoded as key &quot;len&quot; in CBOR
  Len uint32 `codec:&quot;len,omitempty&quot;`
</code></pre>
<p>But encoding a Dart Class into CBOR / JSON is cumbersome and error-prone...</p>
<pre><code class="language-dart">//  In Dart...
class ImageUploadReq  {
  int Len;
  ...
  void Encode(cbor.MapBuilder builder) {
    //  Class Field &quot;Len&quot; will be encoded as key &quot;len&quot; in CBOR
    builder.writeString(&quot;len&quot;);
    builder.writeInt(Len);
</code></pre>
</li>
</ol>
<p><em>Surely a computer can do this tedious and mechanical conversion from Go to Dart?</em></p>
<p>Yes it can, with an <strong>Abstract Syntax Tree</strong>!</p>
<h1 id="whats-an-abstract-syntax-tree" class="section-header"><a href="#whats-an-abstract-syntax-tree">3 What's an Abstract Syntax Tree?</a></h1>
<p>TODO</p>
<h1 id="generate-an-abstract-syntax-tree" class="section-header"><a href="#generate-an-abstract-syntax-tree">4 Generate an Abstract Syntax Tree</a></h1>
<p>TODO</p>
<p>Here is the code that generates an Abstract Syntax Tree given a block of Go code: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// Inspect the Abstract Syntax Tree of our Go code and convert to Dart
func convertGoToDart() {
  fmt.Printf(&quot;//  Go Code...\n%s\n&quot;, src)
  fmt.Println(&quot;//  Converted To Dart...\n&quot;)

  // Create the Abstract Syntax Tree by parsing Go code
  fileset := token.NewFileSet()                            // Positions are relative to fileset
  node, err := parser.ParseFile(fileset, &quot;src.go&quot;, src, 0) // Change src to nil to parse a file instead of string
  if err != nil {
    panic(err)
  }
  ...
}
</code></pre>
<p>Why use Abstract Syntax Tree not LLVM?</p>
<h1 id="walk-the-abstract-syntax-tree" class="section-header"><a href="#walk-the-abstract-syntax-tree">5 Walk the Abstract Syntax Tree</a></h1>
<p>TODO</p>
<p>Here is the code that walks an Abstract Syntax Tree and converts each chunk of Go code: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// Inspect the Abstract Syntax Tree of our Go code and convert to Dart
func convertGoToDart() {
  // Omitted: Create the Abstract Syntax Tree by parsing Go code
  ...
  // Convert all Go Struct and Function Declarations
  for _, decl := range node.Decls {
    // ast.Print(fileset, decl)
    switch decl := decl.(type) {
    case *ast.GenDecl:
      // Convert Go Struct to Dart
      convertStruct(fileset, decl)
    case *ast.FuncDecl:
      // Convert Go Function to Dart
      convertFunction(fileset, decl)
    default:
      fmt.Println(&quot;*** Unknown Decl:&quot;)
      ast.Print(fileset, decl)
    }
  }
}
</code></pre>
<h1 id="auto-convert-go-type-to-dart" class="section-header"><a href="#auto-convert-go-type-to-dart">6 Auto Convert Go Type to Dart</a></h1>
<p>TODO</p>
<p>Here is the code that converts a Go Type to Dart and CBOR: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// DartField represents a Go Struct Field converted to Dart and CBOR
type DartField struct {
  Name     string // &quot;Len&quot;
  CborName string // &quot;len&quot;
  GoType   string // &quot;uint32&quot;
  DartType string // &quot;int&quot;
  CborType string // &quot;Int&quot;
}
</code></pre>
<pre><code class="language-go">// Convert a Go type to Dart type and CBOR type
func convertType(typeName string) (string, string) {
  switch typeName {
  case &quot;bool&quot;:
    return &quot;bool&quot;, &quot;Bool&quot;
  case &quot;uint8&quot;:
    return &quot;int&quot;, &quot;Int&quot;
  case &quot;uint16&quot;:
    return &quot;int&quot;, &quot;Int&quot;
  case &quot;uint32&quot;:
    return &quot;int&quot;, &quot;Int&quot;
  case &quot;[]byte&quot;:
    return &quot;typed.Uint8Buffer&quot;, &quot;Array&quot;
  default:
    return &quot;UNKNOWN&quot;, &quot;UNKNOWN&quot;
  }
}
</code></pre>
<pre><code class="language-go">// Convert a Go Struct Field to Dart
func convertField(fileset *token.FileSet, astField *ast.Field) DartField {
  dartField := DartField{}
  if len(astField.Names) &gt; 0 {
    dartField.Name = astField.Names[0].Name // &quot;Len&quot;
  }
  dartField.GoType = fmt.Sprintf(&quot;%v&quot;, astField.Type) // &quot;uint32&quot;
  // Handle &quot;&amp;{181 &lt;nil&gt; byte}&quot; as &quot;[]byte&quot;
  if strings.HasPrefix(dartField.GoType, &quot;&amp;{&quot;) &amp;&amp; strings.HasSuffix(dartField.GoType, &quot; byte}&quot;) {
    dartField.GoType = &quot;[]byte&quot;
  }
  dartField.DartType, dartField.CborType = convertType(dartField.GoType) // &quot;int&quot;

  // Convert a Field Tag like `codec:&quot;len,omitempty&quot;`. CborName will be set to &quot;len&quot;.
  if astField.Tag != nil {
    dartField.CborName = strings.Split(astField.Tag.Value, &quot;,&quot;)[0]
    dartField.CborName = strings.Replace(dartField.CborName, &quot;codec:&quot;, &quot;&quot;, 1)
    dartField.CborName = strings.Replace(dartField.CborName, `&quot;`, &quot;&quot;, 2)
    dartField.CborName = strings.Replace(dartField.CborName, &quot;`&quot;, &quot;&quot;, 2)
  }
  // fmt.Printf(&quot;field: %s,\tcbor: %s,\ttype: %s,\tdart: %s\n&quot;, dartField.Name, dartField.CborName, dartField.GoType, dartField.DartType)
  return dartField
}
</code></pre>
<h1 id="auto-convert-go-struct-to-dart" class="section-header"><a href="#auto-convert-go-struct-to-dart">7 Auto Convert Go Struct to Dart</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/image.go"><code>nmxact/nmp/image.go</code></a></p>
<pre><code class="language-go">//  Convert From Go...
//  Go Struct
type ImageUploadReq struct {
  NmpBase  `codec:&quot;-&quot;`
  ImageNum uint8  `codec:&quot;image&quot;`
  Off      uint32 `codec:&quot;off&quot;`
  Len      uint32 `codec:&quot;len,omitempty&quot;`
  DataSha  []byte `codec:&quot;sha,omitempty&quot;`
  Upgrade  bool   `codec:&quot;upgrade,omitempty&quot;`
  Data     []byte `codec:&quot;data&quot;`
}
</code></pre>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/nmp/image.dart"><code>dart/nmp/image.dart</code></a></p>
<pre><code class="language-dart">//  Converted To Dart...
//  Converted Dart Class
class ImageUploadReq 
  with NmpBase       //  Get and set SMP Message Header
  implements NmpReq  //  SMP Request Message
{
  int ImageNum; //  image: uint8
  int Off;      //  off: uint32
  int Len;      //  len: uint32
  typed.Uint8Buffer DataSha;  //  sha: []byte
  bool Upgrade;               //  upgrade: bool
  typed.Uint8Buffer Data;     //  data: []byte

  NmpMsg Msg() { return MsgFromReq(this); }

  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
    //  ...Omitted...
  }
}
</code></pre>
<p>Here is the code that converts a Go Struct to Dart: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// Convert Go Struct to Dart
func convertStruct(fileset *token.FileSet, decl *ast.GenDecl) {
  // ast.Print(fileset, decl)
  switch decl.Tok.String() {
  case &quot;type&quot;:
    // Convert a type declaration
    for _, spec := range decl.Specs {
      // ast.Print(fileset, spec)
      switch spec := spec.(type) {
      case *ast.TypeSpec:
        // Get the struct name and output the Dart class
        typeName := spec.Name.Name // &quot;NmpHdr&quot;
        fmt.Printf(&quot;class %s &quot;, typeName)

        // If this is a request message struct...
        if strings.HasSuffix(typeName, &quot;Req&quot;) {
          // Add the Dart mixin and interface classes
          fmt.Println(&quot;&quot;)
          fmt.Println(&quot;  with NmpBase       //  Get and set SMP Message Header&quot;)
          fmt.Println(&quot;  implements NmpReq  //  SMP Request Message&quot;)
        }
        fmt.Println(&quot;{&quot;)

        switch structType := spec.Type.(type) {
        case *ast.StructType: // &quot;struct {&quot;
          // Convert the struct fields
          fields := structType.Fields.List
          convertFields(fileset, fields)
          fmt.Println(&quot;&quot;)

          // If this is a request message struct...
          if strings.HasSuffix(typeName, &quot;Req&quot;) {
            fmt.Println(&quot;  NmpMsg Msg() { return MsgFromReq(this); }\n&quot;)
            // Generate CBOR encoder
            generateCborEncoder(fileset, fields)
          }
</code></pre>
<p>Code conversion is fuzzy and somewhat unreliable, so we always put checks to ensure that we are interpreting the code correctly...</p>
<pre><code class="language-go">        default:
          fmt.Println(&quot;*** Unknown Spec Type:&quot;)
          ast.Print(fileset, spec.Type)
        }

      default:
        fmt.Println(&quot;*** Unknown Spec:&quot;)
        ast.Print(fileset, spec)
      }
    }
    fmt.Println(&quot;}\n&quot;)

  default:
    fmt.Println(&quot;*** Unknown Tok:&quot;)
    ast.Print(fileset, decl.Tok)
  }
}
</code></pre>
<pre><code class="language-go">// Convert Go Struct Fields to Dart
func convertFields(fileset *token.FileSet, astFields []*ast.Field) {
  for _, field := range astFields {
    // ast.Print(fileset, field)
    dartField := convertField(fileset, field)
    if dartField.Name != &quot;&quot; {
      fmt.Printf(&quot;  %s %s;\t//  %s: %s\n&quot;, dartField.DartType, dartField.Name, dartField.CborName, dartField.GoType)
    }
  }
}
</code></pre>
<h1 id="auto-generate-cbor-encoder" class="section-header"><a href="#auto-generate-cbor-encoder">8 Auto Generate CBOR Encoder</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/image.go"><code>nmxact/nmp/image.go</code></a></p>
<pre><code class="language-go">//  Convert From Go...
//  Go Struct
type ImageUploadReq struct {
  NmpBase  `codec:&quot;-&quot;`
  ImageNum uint8  `codec:&quot;image&quot;`
  Off      uint32 `codec:&quot;off&quot;`
  Len      uint32 `codec:&quot;len,omitempty&quot;`
  DataSha  []byte `codec:&quot;sha,omitempty&quot;`
  Upgrade  bool   `codec:&quot;upgrade,omitempty&quot;`
  Data     []byte `codec:&quot;data&quot;`
}
</code></pre>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/nmp/image.dart"><code>dart/nmp/image.dart</code></a></p>
<pre><code class="language-dart">//  Converted To Dart...
//  Converted Dart Class
class ImageUploadReq 
  with NmpBase       //  Get and set SMP Message Header
  implements NmpReq  //  SMP Request Message
{
  ...
  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
    builder.writeString(&quot;image&quot;);
    builder.writeInt(ImageNum); // uint8
    builder.writeString(&quot;off&quot;);
    builder.writeInt(Off);      // uint32
    builder.writeString(&quot;len&quot;);
    builder.writeInt(Len);      // uint32
    builder.writeString(&quot;sha&quot;);
    builder.writeArray(DataSha);// []byte
    builder.writeString(&quot;upgrade&quot;);
    builder.writeBool(Upgrade); // bool
    builder.writeString(&quot;data&quot;);
    builder.writeArray(Data);   // []byte
  }
}
</code></pre>
<p>Here is the code that generates the CBOR Encoder for a Go Struct: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// Generate the Dart CBOR Encoder function for the Go Struct Fields
func generateCborEncoder(fileset *token.FileSet, astFields []*ast.Field) {
  fmt.Println(&quot;  /// Encode the SMP Request fields to CBOR&quot;)
  fmt.Println(&quot;  void Encode(cbor.MapBuilder builder) {&quot;)
  for _, field := range astFields {
    // ast.Print(fileset, field)
    dartField := convertField(fileset, field)
    if dartField.CborName != &quot;-&quot; { // Fields tagged `codec:&quot;-&quot;` will not be ended
      // Encode the string key
      fmt.Printf(&quot;    builder.writeString(\&quot;%s\&quot;);\n&quot;, dartField.CborName)
      // Encode the value
      fmt.Printf(&quot;    builder.write%s(%s);\t// %s\n&quot;, dartField.CborType, dartField.Name, dartField.GoType)
    }
  }
  fmt.Println(&quot;  }&quot;)
}
</code></pre>
<h1 id="auto-convert-go-function-to-dart" class="section-header"><a href="#auto-convert-go-function-to-dart">9 Auto Convert Go Function to Dart</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/image.go"><code>nmxact/nmp/image.go</code></a></p>
<pre><code class="language-go">//  Convert From Go...
//  Go Function
func NewImageUploadReq() *ImageUploadReq {
  r := &amp;ImageUploadReq{}
  fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD)
  return r
}
</code></pre>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/nmp/image.dart"><code>dart/nmp/image.dart</code></a></p>
<pre><code class="language-dart">//  Converted To Dart...
//  Converted Dart Function
ImageUploadReq NewImageUploadReq() {
  var r = ImageUploadReq();
  fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD);
  return r;
}
</code></pre>
<p>Here is the code that converts a Go function to Dart: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/ast/dart/convert.go"><code>dart/convert.go</code></a></p>
<pre><code class="language-go">// Convert Go Function to Dart
func convertFunction(fileset *token.FileSet, decl *ast.FuncDecl) {
  // ast.Print(fileset, decl)
  name := decl.Name                                               // Function Name: &quot;NewImageUploadReq&quot;
  returnType := fmt.Sprintf(&quot;%v&quot;, decl.Type.Results.List[0].Type) // Return Type: &quot;&amp;{40 ImageUploadReq}&quot;

  // Convert the return type &quot;&amp;{40 ImageUploadReq}&quot; to &quot;ImageUploadReq&quot;
  if strings.HasPrefix(returnType, &quot;&amp;{&quot;) &amp;&amp; strings.HasSuffix(returnType, &quot;}&quot;) {
    returnType = strings.Split(returnType, &quot; &quot;)[1]
    returnType = strings.Replace(returnType, &quot;}&quot;, &quot;&quot;, 1)
  }
  // TODO: Convert function parameters

  // Output function declaration
  fmt.Printf(&quot;%s %s() {\n&quot;, returnType, name)

  // Convert the statements in the body
  body := decl.Body.List
  for _, stmt := range body {
    // ast.Print(fileset, stmt)
    // Convert the statement to a string
    var buf bytes.Buffer
    if err := format.Node(&amp;buf, fileset, stmt); err != nil {
      panic(err)
    }
    dartStmt := fmt.Sprintf(&quot;%s&quot;, buf.Bytes()) // &quot;r := &amp;ImageUploadReq{}&quot;

    // Convert specific kinds of statements
    switch stmt.(type) {
    case *ast.AssignStmt:
      // For Assignment Statement &quot;r := &amp;ImageUploadReq{}&quot;, rewrite to &quot;var r = ImageUploadReq()&quot;
      dartStmt = strings.Replace(dartStmt, &quot;:=&quot;, &quot;=&quot;, 1)
      dartStmt = strings.Replace(dartStmt, &quot;&amp;&quot;, &quot;&quot;, 1)
      dartStmt = strings.Replace(dartStmt, &quot;{}&quot;, &quot;()&quot;, 1)
      dartStmt = &quot;var &quot; + dartStmt
    }

    // Terminate every statement with semicolon
    fmt.Printf(&quot;  %s;\n&quot;, dartStmt)
  }
  // End of function
  fmt.Println(&quot;}\n&quot;)
}
</code></pre>
<h1 id="test-auto-conversion" class="section-header"><a href="#test-auto-conversion">10 Test Auto Conversion</a></h1>
<p>TODO</p>

<pre><code>&gt; Executing task: /usr/local/go/bin/go run dart/convert.go &lt;

//  Go Code...

package main

type ImageUploadReq struct {
        NmpBase  `codec:&quot;-&quot;`
        ImageNum uint8  `codec:&quot;image&quot;`
        Off      uint32 `codec:&quot;off&quot;`
        Len      uint32 `codec:&quot;len,omitempty&quot;`
        DataSha  []byte `codec:&quot;sha,omitempty&quot;`
        Upgrade  bool   `codec:&quot;upgrade,omitempty&quot;`
        Data     []byte `codec:&quot;data&quot;`
}

func NewImageUploadReq() *ImageUploadReq {
        r := &amp;ImageUploadReq{}
        fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD)
        return r
}

//  Converted To Dart...

class ImageUploadReq 
  with NmpBase       //  Get and set SMP Message Header
  implements NmpReq  //  SMP Request Message
{
  int ImageNum; //  image: uint8
  int Off;      //  off: uint32
  int Len;      //  len: uint32
  typed.Uint8Buffer DataSha;    //  sha: []byte
  bool Upgrade; //  upgrade: bool
  typed.Uint8Buffer Data;       //  data: []byte

  NmpMsg Msg() { return MsgFromReq(this); }

  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
    builder.writeString(&quot;image&quot;);
    builder.writeInt(ImageNum); // uint8
    builder.writeString(&quot;off&quot;);
    builder.writeInt(Off);      // uint32
    builder.writeString(&quot;len&quot;);
    builder.writeInt(Len);      // uint32
    builder.writeString(&quot;sha&quot;);
    builder.writeArray(DataSha);        // []byte
    builder.writeString(&quot;upgrade&quot;);
    builder.writeBool(Upgrade); // bool
    builder.writeString(&quot;data&quot;);
    builder.writeArray(Data);   // []byte
  }
}

ImageUploadReq NewImageUploadReq() {
  var r = ImageUploadReq();
  fillNmpReq(r, NMP_OP_WRITE, NMP_GROUP_IMAGE, NMP_ID_IMAGE_UPLOAD);
  return r;
}</code></pre><h1 id="whats-next" class="section-header"><a href="#whats-next">11 What's Next</a></h1>
<p>TODO</p>
<p>The code in this article is part of the upcoming open source <a href="https://github.com/lupyuen/pinetime-companion"><strong>PineTime Companion App</strong></a> for Android and iOS. So that we can update the firmware on our PineTime Smart Watches wirelessly, sync the date and time, show notifications from our phone, chart our heart rate, ... Maybe even control our smart home gadgets! </p>
<p>We'll be doing lots more coding...</p>
<ol>
<li>
<p><strong>Handle Other PineTime Commands:</strong> Update firmware, sync date and time, show mobile notifications, control smart home gadgets (via IFTTT and MQTT), ...</p>
<p>We shall do this by taking the <a href="https://github.com/apache/mynewt-newtmgr">Newt Manager</a> code in Go and converting it to Flutter and Dart, as explained here...</p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/companion">&quot;Convert Go to Flutter and Dart for PineTime Companion App&quot;</a></em></p>
</li>
<li>
<p><strong>Companion App for Linux Phones (like PinePhone):</strong> We shall take the <a href="https://github.com/apache/mynewt-newtmgr">Newt Manager</a> code in Go and wrap it into a GTK3 app, using the <a href="https://github.com/gotk3/gotk3"><code>gotk3</code> library</a>...</p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/gotk3">&quot;Your First GTK App with Go and VSCodium&quot;</a></em></p>
</li>
<li>
<p><strong>PineTime Firmware Support:</strong> Today our PineTime Companion App talks to Mynewt and Zephyr operating systems on PineTime. We hope to implement the same Bluetooth LE protocol (Simple Management Protocol) on other operating systems, so that they may also enjoy wireless firmware updates...</p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">&quot;Firmware Update over Bluetooth Low Energy on PineTime Smart Watch&quot;</a></em></p>
</li>
</ol>
<p><em>Why are we maintaining two code bases: Flutter (for Android and iOS) and Go (for Linux phones)?</em></p>
<p>Because Flutter is probably the best way to build mobile apps... But it's not officially supported for Linux phones.  The <code>flutter_blue</code> plugin doesn't support Linux either.</p>
<p>So we need to stick with Go for Linux phones.</p>
<p>We're now exploring <a href="https://github.com/go-flutter-desktop/go-flutter"><strong><code>go-flutter</code></strong></a> for porting the Flutter App to Linux. And recode <code>flutter_blue</code> via FFI to a Linux Bluetooth LE library (in Go or C).</p>
<p><em>(Maybe someday when Flutter is officially supported on Linux phones, we can scrap the Go version!)</em></p>
<p>If you're keen to help out with the PineTime Companion App (or anything else in PineTime), <strong>come chat with the PineTime FOSS Community (and me) in the PineTime Chatroom!</strong></p>
<p><a href="https://wiki.pine64.org/index.php/PineTime#Community">PineTime Chatroom on Matrix / Discord / Telegram / IRC</a></p>
<h1 id="further-reading" class="section-header"><a href="#further-reading">12 Further Reading</a></h1>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/bloc">&quot;Flutter State Management with Bloc for PineTime Companion App&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/companion">&quot;Convert Go to Flutter and Dart for PineTime Companion App&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/flutter">&quot;Your First Bluetooth Low Energy App with Flutter&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/gotk3">&quot;Your First GTK App with Go and VSCodium&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot">&quot;MCUBoot Bootloader for PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">&quot;Firmware Update over Bluetooth Low Energy on PineTime Smart Watch&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">&quot;Wireless Firmware Update In Action on PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>

    
</body>
</html>