<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Convert Go to Flutter and Dart for PineTime Companion App</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Convert Go to Flutter and Dart for PineTime Companion App" 
    data-rh="true">
<meta property="og:description" 
    content="How we build the Flutter Companion App (Android and iOS) for PineTime Smart Watch by converting Go to Dart" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/companion-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Convert Go to Flutter and Dart for PineTime Companion App</h1>
    <nav id="TOC"><ul>
<li><a href="#go-vs-dart-coding">1 Go vs Dart Coding</a><ul></ul></li>
<li><a href="#convert-go-structs-methods-and-interfaces-to-dart">2 Convert Go Structs, Methods and Interfaces to Dart</a><ul>
<li><a href="#go-structs-become-dart-classes">2.1 Go Structs Become Dart Classes</a><ul></ul></li>
<li><a href="#move-methods-inside-classes">2.2 Move Methods Inside Classes</a><ul></ul></li>
<li><a href="#add-dart-constructors">2.3 Add Dart Constructors</a><ul></ul></li>
<li><a href="#go-interfaces-become-dart-abstract-classes">2.4 Go Interfaces Become Dart Abstract Classes</a><ul></ul></li></ul></li>
<li><a href="#but-some-go-structs-become-dart-mixins">3 But Some Go Structs Become Dart Mixins</a><ul></ul></li>
<li><a href="#convert-go-to-dart-line-by-line">4 Convert Go to Dart line by line</a><ul></ul></li>
<li><a href="#cbor-encoding-in-dart">5 CBOR Encoding in Dart</a><ul></ul></li>
<li><a href="#dive-deep-into-newt-manager-in-go">6 Dive Deep into Newt Manager in Go</a><ul></ul></li>
<li><a href="#embed-dart-modules-in-flutter">7 Embed Dart modules in Flutter</a><ul></ul></li>
<li><a href="#transmit-gatt-requests-in-flutter">8 Transmit GATT Requests in Flutter</a><ul></ul></li>
<li><a href="#handle-gatt-responses-and-notifications-in-flutter">9 Handle GATT Responses and Notifications in Flutter</a><ul></ul></li>
<li><a href="#dart-extension-for-vscode">10 Dart Extension for VSCode</a><ul></ul></li>
<li><a href="#install-dart-on-raspberry-pi-and-pinebook-pro">11 Install Dart on Raspberry Pi and Pinebook Pro</a><ul></ul></li>
<li><a href="#whats-next">12 What's Next</a><ul></ul></li>
<li><a href="#further-reading">13 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/companion-title.png" alt="Convert Go to Flutter and Dart for PineTime Companion App" /></p>
<p>Can we take a <strong>single code base</strong>... And turn it into a mobile app for <strong>Android, iOS and Linux phones</strong> (like PinePhone)?</p>
<p>And code it in a <strong>modern programming language</strong> with <strong>Garbage Collection</strong>... Without the scary C pointers?</p>
<p>And talk <strong>Bluetooth Low Energy</strong> to other gadgets... Like <a href="https://wiki.pine64.org/index.php/PineTime"><strong>PineTime Smart Watch</strong></a>?</p>
<p><strong>Yes we can!</strong> Based on the quick experiment described in this article.</p>
<p>Read on to learn how we are building the <a href="https://github.com/lupyuen/pinetime-companion">Flutter Companion App</a> for PineTime Smart Watch... By converting the Go code (on Linux) to Flutter + Dart (on Android and iOS), line by line. (It's actually not that hard!)</p>
<p>The code is not 100% identical, but it will save the PineTime FOSS Community a lot of effort in maintaining the Android, iOS and Linux versions of the PineTime Companion App.</p>
<p>I'll explain how this Linux Command Line App in Go...</p>
<p><img src="https://lupyuen.github.io/images/companion-newtmgr.png" alt="Newt Manager showing response from PineTime Smart Watch" /></p>
<p><em>(Which will eventually be dressed up with <a href="https://github.com/gotk3/gotk3"><code>gotk3</code></a>, the GTK3 library for Go)</em></p>
<p>...Was converted line by line to this Flutter app for Android and iOS...</p>
<p><img src="https://lupyuen.github.io/images/companion-response.png" alt="Flutter Companion App showing response from PineTime Smart Watch" /></p>
<p><em>(The highlighted part shows the identical responses returned by PineTime to both apps over Bluetooth LE. So it really works!)</em></p>
<h1 id="go-vs-dart-coding" class="section-header"><a href="#go-vs-dart-coding">1 Go vs Dart Coding</a></h1>
<p>Let's learn to convert this chunk of Go code from <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L36-L45"><code>nmxact/nmp/nmp.go</code></a>...</p>
<pre><code class="language-go">//  In Go...
const NMP_HDR_SIZE = 8

/// SMP Header
type NmpHdr struct {
  Op    uint8  //  3 bits of opcode
  Flags uint8
  Len   uint16
  Group uint16
  Seq   uint8
  Id    uint8
}

/// Return this SMP Header as a list of bytes
func (hdr *NmpHdr) Bytes() []byte {
  buf := make([]byte, 0, NMP_HDR_SIZE)

  buf = append(buf, byte(hdr.Op))
  buf = append(buf, byte(hdr.Flags))

  u16b := make([]byte, 2)
  binary.BigEndian.PutUint16(u16b, hdr.Len)
  buf = append(buf, u16b...)

  binary.BigEndian.PutUint16(u16b, hdr.Group)
  buf = append(buf, u16b...)

  buf = append(buf, byte(hdr.Seq))
  buf = append(buf, byte(hdr.Id))

  return buf
}
</code></pre>
<p>...To Dart: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L27-L67"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">//  In Dart...
const NMP_HDR_SIZE = 8;

/// SMP Header
class NmpHdr {
  int Op;    //  Previously uint8
  int Flags; //  Previously uint8
  int Len;   //  Previously uint16
  int Group; //  Previously uint16
  int Seq;   //  Previously uint8
  int Id;    //  Previously uint8
  
  /// Construct an SMP Header
  NmpHdr(
    this.Op,
    this.Flags,
    this.Len,
    this.Group,
    this.Seq,
    this.Id
  );
  
  /// Return this SMP Header as a list of bytes
  typed.Uint8Buffer Bytes() {  //  Previously returns []byte
    var buf = typed.Uint8Buffer();
    
    buf.add(this.Op);
    buf.add(this.Flags);

    typed.Uint8Buffer u16b = binaryBigEndianPutUint16(this.Len);
    buf.addAll(u16b);

    u16b = binaryBigEndianPutUint16(this.Group);
    buf.addAll(u16b);

    buf.add(this.Seq);
    buf.add(this.Id);
    assert(buf.length == NMP_HDR_SIZE);

    return buf;
  }  
}
</code></pre>
<p><em>How shall we begin the code conversion from Go to Dart?</em></p>
<ol>
<li>
<p><strong>Add the trailing semicolons (<code>;</code>)</strong></p>
<p>Semicolons are optional in Go, but mandatory in Dart. So every line in Dart needs to terminate with a semicolon. Hence this code in Go...</p>
<pre><code class="language-go">//  In Go...
const NMP_HDR_SIZE = 8
</code></pre>
<p>Becomes this code in Dart...</p>
<pre><code class="language-dart">//  In Dart...
const NMP_HDR_SIZE = 8;
</code></pre>
</li>
<li>
<p><strong>Flip the names and types of variables</strong></p>
<p>Go puts the variable name before the type name... Dart does it the other way around. Hence this code in Go...</p>
<pre><code class="language-go">//  In Go...
Op uint8
</code></pre>
<p>Becomes this code in Dart...</p>
<pre><code class="language-dart">//  In Dart...
int Op;
</code></pre>
</li>
<li>
<p>Dart doesn't have specific numeric types like <code>uint8</code> (unsigned 8-bit integer). So we use <code>int</code> to represent a byte.</p>
<p>We write assertions in Dart to make sure that the <code>int</code> values are indeed bytes...</p>
<pre><code class="language-dart">//  In Dart...
assert(val &gt;= 0 &amp;&amp; val &lt;= 255);  //  val must be a byte
</code></pre>
</li>
<li>
<p>We rewrite Go byte arrays <code>[]byte</code> as the Dart type <code>typed.Uint8Buffer</code> (from the helper library <a href="https://pub.dev/packages/typed_data"><code>typed_data</code></a>)...</p>
<pre><code class="language-go">//  In Go...
//  Bytes() is a function that returns a byte array
func (hdr *NmpHdr) Bytes() []byte {
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
//  Bytes() is a function that returns a byte array
typed.Uint8Buffer Bytes() {
</code></pre>
</li>
</ol>
<p>Read on for more conversion steps.</p>
<h1 id="convert-go-structs-methods-and-interfaces-to-dart" class="section-header"><a href="#convert-go-structs-methods-and-interfaces-to-dart">2 Convert Go Structs, Methods and Interfaces to Dart</a></h1>
<p>These language overview docs are very helpful when converting Go to Dart...</p>
<ol>
<li>
<p><a href="https://benhoyt.com/writings/go-intro/"><em>&quot;An intro to Go for non-Go developers&quot;</em></a></p>
</li>
<li>
<p><a href="https://dart.dev/guides/language/language-tour"><em>&quot;A tour of the Dart language&quot;</em></a></p>
</li>
</ol>
<p>I'm new to Dart and it looks like a mix of Java and JavaScript. But like Go (and unlike JavaScript), Dart is Static Typed with Type Inference, which simplifies the code conversion.</p>
<h2 id="go-structs-become-dart-classes" class="section-header"><a href="#go-structs-become-dart-classes">2.1 Go Structs Become Dart Classes</a></h2>
<p>We rewrite a Go <code>struct</code> as a Dart <code>class</code>...</p>
<pre><code class="language-go">//  In Go...
type NmpHdr struct {
  Op uint8
  ...
}
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;
  ...
}
</code></pre>
<h2 id="move-methods-inside-classes" class="section-header"><a href="#move-methods-inside-classes">2.2 Move Methods Inside Classes</a></h2>
<p>We move Go methods inside Dart classes...</p>
<pre><code class="language-go">//  In Go...
type NmpHdr struct {
  Op uint8
  ...
}

//  Bytes() method for NmpHdr
func (hdr *NmpHdr) Bytes() []byte { ...
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;
  ...
  //  Bytes() method for NmpHdr
  typed.Uint8Buffer Bytes() { ...
}
</code></pre>
<h2 id="add-dart-constructors" class="section-header"><a href="#add-dart-constructors">2.3 Add Dart Constructors</a></h2>
<p>Go has implicit constructors for <code>structs</code>. We'll have to add Dart constructors like this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;

  //  Constructor for NmpHdr
  NmpHdr(
    this.Op
  );
}
</code></pre>
<p><code>NmpHdr</code> is the common Message Header that we'll be transmit to PineTime (and receive from PineTime) for all our Bluetooth LE messages.</p>
<h2 id="go-interfaces-become-dart-abstract-classes" class="section-header"><a href="#go-interfaces-become-dart-abstract-classes">2.4 Go Interfaces Become Dart Abstract Classes</a></h2>
<p>We rewrite a Go <code>interface</code> (<a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L53-L59"><code>nmxact/nmp/nmp.go</code></a>)...</p>
<pre><code class="language-go">//  In Go...
type NmpReq interface {
  Hdr() *NmpHdr
  SetHdr(hdr *NmpHdr)
</code></pre>
<p>...As a Dart <code>abstract class</code> (<a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L78-L86"><code>newtmgr.dart</code></a>)</p>
<pre><code class="language-dart">//  In Dart...
abstract class NmpReq {
  NmpHdr Hdr();
  void SetHdr(NmpHdr hdr);
</code></pre>
<p><code>NmpReq</code> is the abstract base class for Request Messages that we'll be transmitting to PineTime over Bluetooth LE.</p>
<h1 id="but-some-go-structs-become-dart-mixins" class="section-header"><a href="#but-some-go-structs-become-dart-mixins">3 But Some Go Structs Become Dart Mixins</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L67-L79"><code>nmxact/nmp/nmp.go</code></a></p>
<pre><code class="language-go">/// In Go...
/// SMP Base Message
type NmpBase struct {
  hdr NmpHdr `codec:&quot;-&quot;`
}

/// Get the SMP Message Header
func (b *NmpBase) Hdr() *NmpHdr {
  return &amp;b.hdr
}

/// Set the SMP Message Header
func (b *NmpBase) SetHdr(h *NmpHdr) {
  b.hdr = *h
}
</code></pre>
<p><a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L95-L107"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">/// In Dart...
/// SMP Base Message
mixin NmpBase {
  NmpHdr hdr;  //  Will not be encoded: `codec:&quot;-&quot;`
  
  /// Get the SMP Message Header
  NmpHdr Hdr() {
    return hdr;
  }
  
  /// Set the SMP Message Header
  void SetHdr(NmpHdr h) {
    hdr = h;
  }
}
</code></pre>
<p>https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L345-L377</p>
<pre><code class="language-dart">/// In Dart...
/// SMP Request to Read Image State
class ImageStateReadReq 
  with NmpBase       //  Mixin to get and set SMP Message Header
  implements NmpReq  //  Interface for SMP Request Message  
{
  NmpBase base;      //  Will not be encoded: `codec:&quot;-&quot;`

  /// Get the SMP Request Message
  NmpMsg Msg() { return MsgFromReq(this); }

  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
      //  Encode an empty body
  }
}
</code></pre>
<p>&quot;Static Duck Typing&quot;</p>
<p>https://benhoyt.com/writings/go-intro/</p>
<p>Interfaces are a little different from those in other languages like Java, where you have to say class MyThing implements ThatInterface explicitly. In Go, if you define all of an interface’s methods on a type, the type implicitly implements that interface, and you can use it wherever the interface is called for – no implements keyword in sight.</p>
<p>Go’s approach has often been called “static duck typing”, and it’s a form of structural typing (TypeScript is another popular language that uses structural typing).</p>
<h1 id="convert-go-to-dart-line-by-line" class="section-header"><a href="#convert-go-to-dart-line-by-line">4 Convert Go to Dart line by line</a></h1>
<p>TODO</p>
<p>make</p>
<p>append</p>
<h1 id="cbor-encoding-in-dart" class="section-header"><a href="#cbor-encoding-in-dart">5 CBOR Encoding in Dart</a></h1>
<p>TODO</p>
<p>Attributes</p>
<h1 id="dive-deep-into-newt-manager-in-go" class="section-header"><a href="#dive-deep-into-newt-manager-in-go">6 Dive Deep into Newt Manager in Go</a></h1>
<p>TODO</p>
<p>Go tracing tools</p>
<h1 id="embed-dart-modules-in-flutter" class="section-header"><a href="#embed-dart-modules-in-flutter">7 Embed Dart modules in Flutter</a></h1>
<p>TODO</p>
<p>https://lupyuen.github.io/pinetime-rust-mynewt/articles/flutter</p>
<p>https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart</p>
<p>https://gist.github.com/lupyuen/1354b090a989a818b403685ecfa12d55</p>
<h1 id="transmit-gatt-requests-in-flutter" class="section-header"><a href="#transmit-gatt-requests-in-flutter">8 Transmit GATT Requests in Flutter</a></h1>
<p>TODO</p>
<h1 id="handle-gatt-responses-and-notifications-in-flutter" class="section-header"><a href="#handle-gatt-responses-and-notifications-in-flutter">9 Handle GATT Responses and Notifications in Flutter</a></h1>
<p>TODO</p>
<h1 id="dart-extension-for-vscode" class="section-header"><a href="#dart-extension-for-vscode">10 Dart Extension for VSCode</a></h1>
<p>TODO</p>
<h1 id="install-dart-on-raspberry-pi-and-pinebook-pro" class="section-header"><a href="#install-dart-on-raspberry-pi-and-pinebook-pro">11 Install Dart on Raspberry Pi and Pinebook Pro</a></h1>
<p>TODO</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">12 What's Next</a></h1>
<p>TODO</p>
<p>I'll be using the code in this article to create the open source <strong>PineTime Companion App</strong> for Android and iOS. So that we can flash our PineTime Smart Watches wirelessly, sync the date and time, show notifications, chart our heart rate, ...</p>
<p>Flutter makes it really easy to maintain a single code base for Android and iOS... And <code>flutter_blue</code> makes Bluetooth LE coding so simple!</p>
<p>If you're keen to help out, come chat with the PineTime FOSS Community (and me) in the PineTime Chatroom!</p>
<p><a href="https://wiki.pine64.org/index.php/PineTime#Community">PineTime Chatroom on Matrix / Discord / Telegram / IRC</a></p>
<h1 id="further-reading" class="section-header"><a href="#further-reading">13 Further Reading</a></h1>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot">&quot;MCUBoot Bootloader for PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">&quot;Firmware Update over Bluetooth Low Energy on PineTime Smart Watch&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">&quot;Wireless Firmware Update In Action on PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>

    
</body>
</html>