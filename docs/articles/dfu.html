<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Firmware Upgrade over Bluetooth Low Energy on PineTime Smart Watch</title>

    
    <!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<script src="../storage.js"></script><noscript>
    <link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Firmware Upgrade over Bluetooth Low Energy on PineTime Smart Watch</h1>
    <nav id="TOC"><ul>
<li><a href="#simple-management-procotol-for-firmware-update">1 Simple Management Procotol for Firmware Update</a><ul></ul></li>
<li><a href="#mcu-manager-library-and-nimble-bluetooth-stack">2 MCU Manager Library and NimBLE Bluetooth Stack</a><ul></ul></li>
<li><a href="#firmware-upgrade-via-bluetooth-le">3 Firmware Upgrade via Bluetooth LE</a><ul></ul></li>
<li><a href="#proposed-solution">4 Proposed Solution</a><ul></ul></li>
<li><a href="#pinetime-firmware">5 PineTime Firmware</a><ul></ul></li>
<li><a href="#newt-manager-modules-used-in-pinetime-firmware">6 Newt Manager Modules used in PineTime Firmware</a><ul></ul></li>
<li><a href="#porting-mcu-manager-library-to-other-pinetime-platforms">7 Porting MCU Manager Library to other PineTime platforms</a><ul></ul></li>
<li><a href="#nrf-connect-client-for-ios-and-android">8 nRF Connect Client for iOS and Android</a><ul></ul></li>
<li><a href="#raspberry-pi-client">9 Raspberry Pi Client</a><ul></ul></li>
<li><a href="#pinephone-client">10 PinePhone Client</a><ul></ul></li>
<li><a href="#android-client">11 Android Client</a><ul></ul></li>
<li><a href="#ios-client">12 iOS Client</a><ul></ul></li>
<li><a href="#flutter-client-for-ios-and-android">13 Flutter Client for iOS and Android</a><ul></ul></li>
<li><a href="#implementing-mcuboot">14 Implementing MCUboot</a><ul></ul></li>
<li><a href="#mcuboot-enhancements">15 MCUboot Enhancements</a><ul></ul></li>
<li><a href="#other-pinetime-bluetooth-firmware-upgrade-solutions">16 Other PineTime Bluetooth Firmware Upgrade Solutions</a><ul></ul></li>
<li><a href="#log-for-raspberry-pi-client">17 Log for Raspberry Pi Client</a><ul></ul></li>
<li><a href="#further-reading">18 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/dfu-platforms.png" alt="Platforms in development for PineTime Smart Watch" /></p>
<p>Thanks to the FOSS Community, <a href="https://wiki.pine64.org/index.php/PineTime">PineTime Smart Watch</a> has an incredible variety of FOSS operating systems in the works: <a href="https://github.com/JF002/Pinetime">FreeRTOS</a>, <a href="https://github.com/daniel-thompson/wasp-os">MicroPython</a>, <a href="https://github.com/lupyuen/pinetime-rust-mynewt">Mynewt</a>, <a href="https://github.com/bosmoment/PineTime-apps">RIOT</a>, Rust <a href="https://github.com/wose/xochron">RTFM</a> (<a href="https://github.com/dbrgn/pinetime-rtfm">another</a>), <a href="https://github.com/aykevl/go-smartwatch">TinyGo</a>, <a href="https://www.tockos.org/">Tock</a>, <a href="https://github.com/najnesnaj/pinetime-zephyr">Zephyr</a> (<a href="https://github.com/Dejvino/pinetime-hermes-firmware.git">another</a>), ...</p>
<p>But these embedded platforms are accessible only by brave PineTime Owners who dare to pry open their watches very carefully... And connect a Raspberry Pi (or ST-Link) to the tiny delicate 4-pin SWD port recessed deep inside... Just to flash the PineTime firmware.</p>
<p><em>What if we could flash any firmware to PineTime from our mobile phone... Without opening the watch?</em></p>
<p>Yes we can! Just download the firmware file into our phone and push it wirelessly to our watch, like this...</p>
<p><img src="https://lupyuen.github.io/images/dfu-flow.png" alt="Firmware Upgrade over Bluetooth Low Energy for PineTime Smart Watch" /></p>
<p><em>Firmware Upgrade over Bluetooth Low Energy for PineTime Smart Watch</em></p>
<p>What's the magic behind this? It's the <strong><a href="https://github.com/apache/mynewt-mcumgr">Simple Management Protocol (SMP)</a></strong></p>
<p>By transmitting a bunch of SMP messages over Bluetooth Low Energy (LE), it's possible to send a file to PineTime and upgrade its firmware. (Assuming that our PineTime supports SMP)</p>
<p><em>What mobile app would we use for flashing PineTime over Bluetooth LE?</em></p>
<p>The <a href="https://www.nordicsemi.com/Software-and-tools/Development-Tools/nRF-Connect-for-mobile">Nordic nRF Connect</a> mobile app for iOS and Android is all that we need for flashing PineTime. Here's how it looks when the app is connected to a PineTime that supports SMP...</p>
<p><img src="https://lupyuen.github.io/images/dfu-nrfconnect.png" alt="nRF Connect mobile app for Firmware Upgrade" /></p>
<p><em>nRF Connect mobile app connected to PineTime for Firmware Upgrade</em></p>
<p>See the circular <code>DFU</code> icon at the top right? That stands for <strong>Direct Firmware Upgrade</strong>.</p>
<p>Tapping the <code>DFU</code> icon will let us select a downloaded firmware file for flashing our watch. It's really that easy!</p>
<p><em>What about PinePhone? Raspberry Pi?</em></p>
<p>PinePhone, Raspberry Pi and other Linux devices may use the open-source <a href="https://github.com/apache/mynewt-newtmgr">Newt Manager</a> tool.  (I have tested Newt Manager on Raspberry Pi with PineTime)</p>
<p>It runs on a command line, but it should be easy to wrap up in a graphical user interface.</p>
<p><em>What needs to be done on PineTime?</em></p>
<p>If you're developing firmware for PineTime: Thanks for the great job! I strongly urge you to implement the SMP protocol in your firmware... It will make PineTime Owners a lot happier when updating their watch firmware!</p>
<p>And we'll give PineTime Owners an easy way to try out all the awesome platforms that the PineTime FOSS Community has to offer!</p>
<p>We would like Pine64 to ship PineTime with a FOSS firmware (created by the PineTime Community) that implements the SMP protocol. So PineTime owners can just unbox their watch and start flashing right away from their phones.</p>
<p>In this article I'll walk you through the steps of implementing the SMP protocol in your PineTime firmware. I'll show you my implementation for Mynewt OS, which you may use for reference.</p>
<h1 id="simple-management-procotol-for-firmware-update" class="section-header"><a href="#simple-management-procotol-for-firmware-update">1 Simple Management Procotol for Firmware Update</a></h1>
<p>The open-source Simple Management Protocol (SMP) was originally created for flashing firmware on devices running Mynewt and Zephyr operating systems.  SMP is based on the Bluetooth LE Generic Attribute (GATT) Profile. </p>
<p>GATT defines the standard way for a Bluetooth LE Client (like our mobile phone) to access a Bluetooth LE Service (like the firmware upgrade service on PineTime). <a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt">More about GATT</a></p>
<p>Here's how the SMP protocol works...</p>
<p><img src="https://lupyuen.github.io/images/dfu-gatt.png" alt="SMP Firmware Upgrade over Bluetooth LE" /></p>
<p><em>SMP Firmware Upgrade over Bluetooth LE</em></p>
<ol>
<li>
<p>PineTime broadcasts its name <code>pinetime</code> over Bluetooth LE to allow mobile phones to discover the smart watch</p>
</li>
<li>
<p>Mobile App connects to PineTime via the advertised name <code>pinetime</code></p>
</li>
<li>
<p>Mobile App queries PineTime for a GATT Service that has ID <code>8D53DC1D-1DB7-4CD3-868B-8A527460AA84</code>. This is the GATT Service ID for SMP.</p>
</li>
<li>
<p>Mobile App then queries PineTime for the GATT Characteristic ID <code>DA2E7828-FBCE-4E01-AE9E-261174997C48</code>. This is the GATT Characteristic ID for SMP.</p>
</li>
<li>
<p>Mobile App uses the GATT Characteristic ID for SMP to transmit an encoded request to update PineTime's firmware. In GATT lingo, we call this sending a &quot;Write Request&quot; to the GATT Characteristic for SMP.</p>
</li>
<li>
<p>PineTime performs the firmware update using the firmware file that was embedded in the request</p>
</li>
</ol>
<p>This flow becomes clearer when we look at the nRF Connect mobile app connected to PineTime. Observe how we connect to PineTime by the device name <code>pinetime</code>, also note the SMP Service and SMP Characteristic that appear under PineTime...</p>
<p><img src="https://lupyuen.github.io/images/dfu-gattapp3.png" alt="nRF Connect mobile app connected to PineTime's SMP Service" /></p>
<p><em>nRF Connect mobile app connected to PineTime's SMP Service</em></p>
<p>The circular <code>DFU</code> icon at top right (Direct Firmware Upgrade) appears when the mobile app detects the presence of the SMP Service and Characteristic. Tapping the <code>DFU</code> icon will transmit a firmware update request to PineTime.</p>
<p><em>How shall we implement the SMP protocol in PineTime firmware?</em></p>
<p>Fortunately there's an open-source library that implements the SMP protocol: the <a href="https://github.com/apache/mynewt-mcumgr"><strong>MCU Manager Library</strong></a>. More about this in the next section.</p>
<p>For reference, the generic SMP protocol is <a href="https://github.com/apache/mynewt-mcumgr">documented here</a>. The SMP protocol based on Bluetooth LE is <a href="https://github.com/apache/mynewt-mcumgr/blob/master/transport/smp-bluetooth.md">documented here</a>.</p>
<h1 id="mcu-manager-library-and-nimble-bluetooth-stack" class="section-header"><a href="#mcu-manager-library-and-nimble-bluetooth-stack">2 MCU Manager Library and NimBLE Bluetooth Stack</a></h1>
<p>TODO</p>
<h1 id="firmware-upgrade-via-bluetooth-le" class="section-header"><a href="#firmware-upgrade-via-bluetooth-le">3 Firmware Upgrade via Bluetooth LE</a></h1>
<p>TODO</p>
<p><strong>Objective:</strong> To allow firmware for PineTime Smart Watch to be upgraded Over-The-Air via Bluetooth LE from a mobile phone or a Linux desktop</p>
<p><strong>Devices To Be Supported:</strong> iOS, Android, PinePhone, Raspberry Pi (includes Linux desktops)</p>
<h1 id="proposed-solution" class="section-header"><a href="#proposed-solution">4 Proposed Solution</a></h1>
<p>TODO</p>
<p>We are exploring the OTA Firmware Update solution based on Apache NimBLE Bluetooth stack and Apache Mynewt OS, which are open source:</p>
<p>https://mynewt.apache.org/latest/tutorials/devmgmt/ota_upgrade_nrf52.html</p>
<p>This solution uses the Newt Manager command-line tool, coded in Go and supported on Linux and macOS:</p>
<p>https://github.com/apache/mynewt-newtmgr</p>
<p>https://mynewt.apache.org/latest/newtmgr/index.html</p>
<p>Or we may use the MCU Manager command-line tool, which is a thin wrapper over the Newt Manager command-line tool:</p>
<p>https://github.com/apache/mynewt-mcumgr-cli</p>
<p>For the firmware, the Newt Manager library (based on the NimBLE stack) needs to be embedded. The Newt Manager library receives the firmware image transmitted by the Newt Manager command-line tool:</p>
<p>https://mynewt.apache.org/latest/tutorials/devmgmt/add_newtmgr.html</p>
<p>https://mynewt.apache.org/latest/os/modules/devmgmt/newtmgr.html</p>
<p>Or we may embed the MCU Manager library (also based on the NimBLE stack):</p>
<p>https://github.com/apache/mynewt-mcumgr/blob/master/README-mynewt.md</p>
<p>https://mynewt.apache.org/latest/os/modules/mcumgr/mcumgr.html</p>
<p>(Newt Manager library vs MCU Manager library: newtmgr supports two wire formats - NMP (plain newtmgr protocol) and OMP (CoAP newtmgr protocol). mcumgr only supports NMP (called “Simple Management Procotol” in mcumgr))</p>
<p>Upon reboot, the MCUboot bootloader swaps the firmware images.  If there is a problem, MCUbot restores the previous firmware image. MCUboot is supported on Mynewt, Zephyr and RIOT OS. More about MCUboot:</p>
<p>https://juullabs-oss.github.io/mcuboot/</p>
<p>The Newt Manager / MCU Manager library is probably portable to other firmware, like FreeRTOS and RIOT OS.  MCU Manager is already supported in Zephyr OS.</p>
<p>PineTime should probably ship with a firmware image containing Newt Manager or MCU Manager so that we may upgrade PineTime to other firmware easily.</p>
<p>The NimBLE Bluetooth stack is now supported on PineTime with the FreeRTOS, Mynewt, RIOT and Zephyr firmwares.</p>
<p>The proposed solution is similar to the Bluetooth OTA Firmware Upgrade solution for Zephyr OS (based on MCU Manager):</p>
<p>https://docs.zephyrproject.org/latest/guides/device_mgmt/dfu.html#</p>
<h1 id="pinetime-firmware" class="section-header"><a href="#pinetime-firmware">5 PineTime Firmware</a></h1>
<p>TODO</p>
<p>Now testing PineTime Mynewt firmware built with Newt Manager library, located at the <code>ota</code> branch of <code>/pinetime-rust-mynewt</code>:</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/tree/ota</p>
<p>The Newt Manager library files have been added here: (<code>ble_*.c</code> and <code>ble_*.h</code>)</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/tree/ota/apps/my_sensor_app/src</p>
<p>The files were derived from the Mynewt <code>bleprph</code> sample:</p>
<p>https://github.com/apache/mynewt-nimble/tree/master/apps/bleprph</p>
<p>PineTime now appears in nRF Connect with DFU enabled:</p>
<p>https://twitter.com/MisterTechBlog/status/1255305379766042626?s=20</p>
<p>Need to implement MCUboot for DFU to work.</p>
<h1 id="newt-manager-modules-used-in-pinetime-firmware" class="section-header"><a href="#newt-manager-modules-used-in-pinetime-firmware">6 Newt Manager Modules used in PineTime Firmware</a></h1>
<p>TODO</p>
<p>The following modules were added to PineTime firmware to support Newt Manager:</p>
<pre><code class="language-yaml"># Bluetooth LE
pkg.deps.BLUETOOTH_LE:
    - &quot;@apache-mynewt-core/boot/split&quot;
    - &quot;@mcuboot/boot/bootutil&quot;
    - &quot;@apache-mynewt-core/mgmt/imgmgr&quot;
    - &quot;@apache-mynewt-core/mgmt/newtmgr&quot;
    - &quot;@apache-mynewt-core/mgmt/newtmgr/transport/ble&quot;
    - &quot;@apache-mynewt-nimble/nimble/host&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/services/ans&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/services/dis&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/services/gap&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/services/gatt&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/store/config&quot;
    - &quot;@apache-mynewt-nimble/nimble/host/util&quot;
    - &quot;@apache-mynewt-nimble/nimble/transport&quot;
</code></pre>
<p><em>From https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota/apps/my_sensor_app/pkg.yml</em></p>
<h1 id="porting-mcu-manager-library-to-other-pinetime-platforms" class="section-header"><a href="#porting-mcu-manager-library-to-other-pinetime-platforms">7 Porting MCU Manager Library to other PineTime platforms</a></h1>
<p>TODO</p>
<p>For upgrading firmware over Bluetooth, the MCU Manager Library is supported on Mynewt OS and Zephyr OS. How do we support MCU Manager on other PineTime platforms like FreeRTOS, RIOT, MicroPython, Rust RTFM and TinyGo?</p>
<p>MCU Manager Library is documented here:</p>
<p>https://github.com/apache/mynewt-mcumgr</p>
<p>MCU Manager runs on the Bluetooth LE transport based on the open-source NimBLE Bluetooth LE stack. The following NimBLE modules need to be ported to the PineTime platform:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/services/ans&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/services/dis&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/services/gap&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/services/gatt&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/store/config&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/host/util&quot;</span>
<span class="op">-</span> <span class="string">&quot;@apache-mynewt-nimble/nimble/transport&quot;</span></pre></div>
<p>Refer to the NimBLE source code at https://github.com/apache/mynewt-nimble</p>
<p>MCU Manager includes Command Handlers for managing Firmware Images, File System, Logging, OS and Runtime Statistics:</p>
<p>https://github.com/apache/mynewt-mcumgr/tree/master/cmd</p>
<p>We'll look at the Command Handler for Firmware Images:</p>
<p>https://github.com/apache/mynewt-mcumgr/tree/master/cmd/img_mgmt</p>
<p>The following Image Management interfaces need to be implemented on the PineTime platform:</p>
<pre><code class="language-c">int img_mgmt_impl_erase_slot(void);
int img_mgmt_impl_write_pending(int slot, bool permanent);
int img_mgmt_impl_write_confirmed(void);
int img_mgmt_impl_read(int slot, unsigned int offset, void *dst,
                       unsigned int num_bytes);
int img_mgmt_impl_write_image_data(unsigned int offset, const void *data,
                                   unsigned int num_bytes, bool last);
int img_mgmt_impl_swap_type(void);
uint8_t img_mgmt_state_flags(int query_slot);
int img_mgmt_impl_erase_image_data(unsigned int off, unsigned int num_bytes);
int img_mgmt_impl_erase_if_needed(uint32_t off, uint32_t len);
int img_mgmt_impl_upload_inspect(const struct img_mgmt_upload_req *req,
                                 struct img_mgmt_upload_action *action,
                                 const char **errstr);
int img_mgmt_impl_log_upload_start(int status);
int img_mgmt_impl_log_upload_done(int status, const uint8_t *hashp);
int img_mgmt_impl_log_pending(int status, const uint8_t *hash);
int img_mgmt_impl_log_confirm(int status, const uint8_t *hash);
</code></pre>
<p><em>From https://github.com/apache/mynewt-mcumgr/blob/master/cmd/img_mgmt/include/img_mgmt/img_mgmt_impl.h</em></p>
<p>For reference, see the Mynewt implementation of Image Management:</p>
<p>https://github.com/apache/mynewt-mcumgr/blob/master/cmd/img_mgmt/port/mynewt/src/mynewt_img_mgmt.c</p>
<p>And the Zephyr implementation of Image Management:</p>
<p>https://github.com/apache/mynewt-mcumgr/blob/master/cmd/img_mgmt/port/zephyr/src/zephyr_img_mgmt.c</p>
<h1 id="nrf-connect-client-for-ios-and-android" class="section-header"><a href="#nrf-connect-client-for-ios-and-android">8 nRF Connect Client for iOS and Android</a></h1>
<p>TODO</p>
<p>The nRF Connect Client for iOS and Android works OK with Newt Manager Library on PineTime, connecting via Simple Management Protocol over Bluetooth LE:</p>
<p>https://twitter.com/MisterTechBlog/status/1255305379766042626?s=20</p>
<p>The DFU function is enabled in nRF Client, but PineTime needs MCUboot to be installed for firmware upgrading to work.</p>
<p>More about nRF Connect: https://www.nordicsemi.com/Software-and-tools/Development-Tools/nRF-Connect-for-mobile</p>
<h1 id="raspberry-pi-client" class="section-header"><a href="#raspberry-pi-client">9 Raspberry Pi Client</a></h1>
<p>TODO</p>
<p>Newt Manager builds OK on Raspberry Pi 4 and works OK with PineTime.  See the log below.</p>
<p>Now studying the Go code (with debug messages enabled) to understand the firmware upload process:</p>
<p>https://mynewt.apache.org/latest/newtmgr/command_list/newtmgr_image.html</p>
<p>Also how to set the device date/time:</p>
<p>https://mynewt.apache.org/latest/newtmgr/command_list/newtmgr_datetime.html</p>
<p>And whether we can push notifications to the device.</p>
<h1 id="pinephone-client" class="section-header"><a href="#pinephone-client">10 PinePhone Client</a></h1>
<p>TODO</p>
<p>Waiting for PinePhone to be delivered. Client will probably be based on Newt Manager or MCU Manager, since Go is supported on Ubuntu Touch.</p>
<p>Will probably wrap the Go client in a Qt GUI app.  Or wrap with a Go GUI library: https://github.com/avelino/awesome-go#gui</p>
<h1 id="android-client" class="section-header"><a href="#android-client">11 Android Client</a></h1>
<p>TODO</p>
<p>Not started. Will explore this Android MCU Manager client for OTA Firmware Upgrade, coded in Java:</p>
<p>https://github.com/JuulLabs-OSS/mcumgr-android</p>
<h1 id="ios-client" class="section-header"><a href="#ios-client">12 iOS Client</a></h1>
<p>TODO</p>
<p>Not started. Will explore this iOS MCU Manager client for OTA Firmware Upgrade, coded in Swift:</p>
<p>https://github.com/JuulLabs-OSS/mcumgr-ios</p>
<p>Among all MCU Manager clients, the Swift version is easiest to understand because it calls high-level BLE functions:</p>
<p>https://github.com/JuulLabs-OSS/mcumgr-ios/blob/master/Source/Bluetooth/McuMgrBleTransport.swift</p>
<p>Now using this code to understand the MCU Manager upload protocol.</p>
<p>Refer to the iOS Core Bluetooth API:</p>
<p>https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html#//apple_ref/doc/uid/TP40013257-CH1-SW1</p>
<p>https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/PerformingCommonCentralRoleTasks/PerformingCommonCentralRoleTasks.html#//apple_ref/doc/uid/TP40013257-CH3-SW1</p>
<h1 id="flutter-client-for-ios-and-android" class="section-header"><a href="#flutter-client-for-ios-and-android">13 Flutter Client for iOS and Android</a></h1>
<p>TODO</p>
<p>Alternatively, we may build iOS and Android clients for MCU Manager in Flutter based on this BLE library:</p>
<p>https://github.com/pauldemarco/flutter_blue</p>
<p>This allows us to maintain a single code base to target both iOS and Android clients.</p>
<p>It looks feasible to build a Flutter client (coded in Dart) based on on this Dart BLE sample:</p>
<p>https://github.com/pauldemarco/flutter_blue/tree/master/example/lib</p>
<p>And adapting the iOS MCU Client code.</p>
<p>The Flutter app for PineTime would the MCU Manager functions from scratch. The app would be a great reference to teach how to talk to BLE and GATT services from iOS and Android, even though it won't be a polished app.</p>
<h1 id="implementing-mcuboot" class="section-header"><a href="#implementing-mcuboot">14 Implementing MCUboot</a></h1>
<p>TODO</p>
<p>MCUboot is not implemented in the Mynewt firmware for PineTime because it doesn't have an allocated slot in Flash ROM for storing the new firmware image. Refer to the Flash Memory Map:</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota/hw/bsp/nrf52/bsp.yml</p>
<p>Note that <code>FLASH_AREA_IMAGE_1</code> and <code>FLASH_AREA_IMAGE_SCRATCH</code> are not usable. </p>
<p>The Flash Memory Map needs to be fixed for MCUboot to work.  The flashing scripts depend on these flash addresses, so the scripts may have to be changed too.</p>
<p>The Flash Memory Map should follow the Mynewt memory map for nRF52:</p>
<p>https://github.com/apache/mynewt-core/blob/master/hw/bsp/nordic_pca10040/bsp.yml</p>
<h1 id="mcuboot-enhancements" class="section-header"><a href="#mcuboot-enhancements">15 MCUboot Enhancements</a></h1>
<p>TODO</p>
<p>MCUboot should detect button press upon startup. If the button is pressed, rollback the old firmware. This allows the user to roll back faulty firmware that does not respond to OTA Firmware Upgrade commands.</p>
<p>The OTA Firmware Upgrade tool needs to ensure that the same firmware version doesn't get flashed twice.</p>
<p>The firmware must still implement a &quot;Reset&quot; or watchdog feature, or the user will have to wait for the battery to drain completely before running MCUboot.</p>
<p>The PineTime Mynewt firmware size is 205 KB with Newt Manager Library included. This is quite close to the 232 KB size limit, assuming 2 firmware images plus scratch storage in PineTime's 512 KB ROM.</p>
<p>MCUboot and MCU Manager should be enhanced to store the new and backup firmware images on PineTime's External SPI Flash (4 MB).</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span> <span class="ident">Build</span> <span class="ident">Mynewt</span> <span class="ident">and</span> <span class="ident">link</span> <span class="ident">with</span> <span class="ident">Rust</span> <span class="ident">app</span>
<span class="op">+</span> <span class="ident">newt</span> <span class="ident">build</span> <span class="ident">nrf52_my_sensor</span>
<span class="ident">Building</span> <span class="ident">target</span> <span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span>
<span class="ident">Linking</span> <span class="op">/</span><span class="ident">Users</span><span class="op">/</span><span class="ident">Luppy</span><span class="op">/</span><span class="ident">PineTime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">apps</span><span class="op">/</span><span class="ident">my_sensor_app</span><span class="op">/</span><span class="ident">my_sensor_app</span>.<span class="ident">elf</span>
<span class="ident">Target</span> <span class="ident">successfully</span> <span class="ident">built</span>: <span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span>
<span class="op">+</span> <span class="ident">newt</span> <span class="ident">size</span> <span class="op">-</span><span class="ident">v</span> <span class="ident">nrf52_my_sensor</span>
<span class="ident">Size</span> <span class="ident">of</span> <span class="ident">Application</span> <span class="ident">Image</span>: <span class="ident">app</span>
<span class="ident">Mem</span> <span class="ident">FLASH</span>: <span class="number">0x8000</span><span class="op">-</span><span class="number">0x7bc00</span>
<span class="ident">Mem</span> <span class="ident">RAM</span>: <span class="number">0x20000000</span><span class="op">-</span><span class="number">0x20010000</span>
  <span class="ident">FLASH</span>     <span class="ident">RAM</span> 
    <span class="number">740</span>     <span class="number">330</span> <span class="kw-2">*</span><span class="ident">fill</span><span class="op">*</span>
   <span class="number">1018</span>      <span class="number">98</span> <span class="ident">apps_my_sensor_app</span>.<span class="ident">a</span>
   <span class="number">1810</span>     <span class="number">112</span> <span class="ident">boot_bootutil</span>.<span class="ident">a</span>
    <span class="number">438</span>      <span class="number">26</span> <span class="ident">boot_split</span>.<span class="ident">a</span>
   <span class="number">1180</span>       <span class="number">0</span> <span class="ident">crypto_mbedtls</span>.<span class="ident">a</span>
   <span class="number">2302</span>       <span class="number">0</span> <span class="ident">crypto_tinycrypt</span>.<span class="ident">a</span>
    <span class="number">401</span>       <span class="number">0</span> <span class="ident">encoding_base64</span>.<span class="ident">a</span>
   <span class="number">1622</span>       <span class="number">0</span> <span class="ident">encoding_cborattr</span>.<span class="ident">a</span>
   <span class="number">3002</span>       <span class="number">0</span> <span class="ident">encoding_tinycbor</span>.<span class="ident">a</span>
    <span class="number">440</span>     <span class="number">444</span> <span class="ident">hw_bsp_nrf52</span>.<span class="ident">a</span>
     <span class="number">52</span>       <span class="number">0</span> <span class="ident">hw_cmsis</span><span class="op">-</span><span class="ident">core</span>.<span class="ident">a</span>
    <span class="number">706</span>       <span class="number">1</span> <span class="ident">hw_hal</span>.<span class="ident">a</span>
   <span class="number">7074</span>     <span class="number">154</span> <span class="ident">hw_mcu_nordic_nrf52xxx</span>.<span class="ident">a</span>
      <span class="number">2</span>       <span class="number">0</span> <span class="ident">hw_sensor_creator</span>.<span class="ident">a</span>
   <span class="number">1264</span>     <span class="number">260</span> <span class="ident">hw_sensor</span>.<span class="ident">a</span>
   <span class="number">8756</span>   <span class="number">35712</span> <span class="ident">kernel_os</span>.<span class="ident">a</span>
   <span class="number">3044</span>      <span class="number">50</span> <span class="ident">libc_baselibc</span>.<span class="ident">a</span>
     <span class="number">16</span>       <span class="number">0</span> <span class="ident">libs_mynewt_rust</span>.<span class="ident">a</span>
  <span class="number">57400</span>    <span class="number">9582</span> <span class="ident">libs_rust_app</span>.<span class="ident">a</span>
  <span class="number">12912</span>       <span class="number">0</span> <span class="ident">libs_rust_libcore</span>.<span class="ident">a</span>
    <span class="number">738</span>      <span class="number">42</span> <span class="ident">libs_semihosting_console</span>.<span class="ident">a</span>
     <span class="number">40</span>       <span class="number">9</span> <span class="ident">libs_sensor_coap</span>.<span class="ident">a</span>
    <span class="number">583</span>      <span class="number">99</span> <span class="ident">libs_sensor_network</span>.<span class="ident">a</span>
    <span class="number">677</span>     <span class="number">212</span> <span class="ident">libs_temp_stub</span>.<span class="ident">a</span>
   <span class="number">3428</span>      <span class="number">72</span> <span class="ident">mgmt_imgmgr</span>.<span class="ident">a</span>
    <span class="number">231</span>      <span class="number">20</span> <span class="ident">mgmt_mgmt</span>.<span class="ident">a</span>
    <span class="number">884</span>     <span class="number">100</span> <span class="ident">mgmt_newtmgr</span>.<span class="ident">a</span>
   <span class="number">1410</span>      <span class="number">44</span> <span class="ident">mgmt_newtmgr_nmgr_os</span>.<span class="ident">a</span>
    <span class="number">454</span>     <span class="number">108</span> <span class="ident">mgmt_newtmgr_transport_ble</span>.<span class="ident">a</span>
    <span class="number">405</span>     <span class="number">388</span> <span class="ident">net_oic</span>.<span class="ident">a</span>
  <span class="number">35496</span>    <span class="number">2107</span> <span class="ident">nimble_controller</span>.<span class="ident">a</span>
   <span class="number">4086</span>    <span class="number">1203</span> <span class="ident">nimble_drivers_nrf52</span>.<span class="ident">a</span>
  <span class="number">41721</span>    <span class="number">2797</span> <span class="ident">nimble_host</span>.<span class="ident">a</span>
    <span class="number">822</span>     <span class="number">218</span> <span class="ident">nimble_host_services_ans</span>.<span class="ident">a</span>
    <span class="number">241</span>     <span class="number">112</span> <span class="ident">nimble_host_services_dis</span>.<span class="ident">a</span>
    <span class="number">396</span>     <span class="number">118</span> <span class="ident">nimble_host_services_gap</span>.<span class="ident">a</span>
    <span class="number">204</span>      <span class="number">62</span> <span class="ident">nimble_host_services_gatt</span>.<span class="ident">a</span>
   <span class="number">1814</span>     <span class="number">648</span> <span class="ident">nimble_host_store_config</span>.<span class="ident">a</span>
    <span class="number">114</span>       <span class="number">0</span> <span class="ident">nimble_host_util</span>.<span class="ident">a</span>
    <span class="number">692</span>    <span class="number">1096</span> <span class="ident">nimble_transport_ram</span>.<span class="ident">a</span>
   <span class="number">1578</span>      <span class="number">54</span> <span class="ident">sys_config</span>.<span class="ident">a</span>
    <span class="number">634</span>     <span class="number">128</span> <span class="ident">sys_flash_map</span>.<span class="ident">a</span>
      <span class="number">2</span>       <span class="number">0</span> <span class="ident">sys_log_modlog</span>.<span class="ident">a</span>
    <span class="number">686</span>      <span class="number">29</span> <span class="ident">sys_mfg</span>.<span class="ident">a</span>
    <span class="number">839</span>      <span class="number">51</span> <span class="ident">sys_reboot</span>.<span class="ident">a</span>
    <span class="number">226</span>      <span class="number">37</span> <span class="ident">sys_sysdown</span>.<span class="ident">a</span>
     <span class="number">30</span>       <span class="number">5</span> <span class="ident">sys_sysinit</span>.<span class="ident">a</span>
   <span class="number">1746</span>       <span class="number">0</span> <span class="ident">time_datetime</span>.<span class="ident">a</span>
    <span class="number">120</span>       <span class="number">0</span> <span class="ident">util_mem</span>.<span class="ident">a</span>
    <span class="number">208</span>       <span class="number">0</span> <span class="ident">nrf52_my_sensor</span><span class="op">-</span><span class="ident">sysinit</span><span class="op">-</span><span class="ident">app</span>.<span class="ident">a</span>
    <span class="number">166</span>       <span class="number">0</span> <span class="ident">libg</span>.<span class="ident">a</span>
    <span class="number">968</span>       <span class="number">0</span> <span class="ident">libgcc</span>.<span class="ident">a</span>
<span class="ident">Loading</span> <span class="ident">compiler</span> <span class="op">/</span><span class="ident">Users</span><span class="op">/</span><span class="ident">Luppy</span><span class="op">/</span><span class="ident">PineTime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">compiler</span><span class="op">/</span><span class="ident">arm</span><span class="op">-</span><span class="ident">none</span><span class="op">-</span><span class="ident">eabi</span><span class="op">-</span><span class="ident">m4</span>, <span class="ident">buildProfile</span> <span class="ident">debug</span>

<span class="ident">objsize</span>
   <span class="ident">text</span>    <span class="ident">data</span>     <span class="ident">bss</span>     <span class="ident">dec</span>     <span class="ident">hex</span> <span class="ident">filename</span>
 <span class="number">205760</span>     <span class="number">904</span>   <span class="number">55224</span>  <span class="number">261888</span>   <span class="number">3ff00</span> <span class="op">/</span><span class="ident">Users</span><span class="op">/</span><span class="ident">Luppy</span><span class="op">/</span><span class="ident">PineTime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">apps</span><span class="op">/</span><span class="ident">my_sensor_app</span><span class="op">/</span><span class="ident">my_sensor_app</span>.<span class="ident">elf</span></pre></div>
<h1 id="other-pinetime-bluetooth-firmware-upgrade-solutions" class="section-header"><a href="#other-pinetime-bluetooth-firmware-upgrade-solutions">16 Other PineTime Bluetooth Firmware Upgrade Solutions</a></h1>
<ol>
<li>
<p>Nordic SoftDevice includes a proprietary BLE DFU implementation: https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.0.0/lib_bootloader_dfu_process.html</p>
</li>
<li>
<p>wasp-os with Adafruit NRF52 Bootloader (based on Nordic SoftDevice): https://github.com/daniel-thompson/wasp-os</p>
</li>
<li>
<p>Gadgetbridge for Android: https://gadgetbridge.org/</p>
</li>
<li>
<p>DaFlasher for Android: https://github.com/atc1441/DaFlasherFiles</p>
</li>
</ol>
<h1 id="log-for-raspberry-pi-client" class="section-header"><a href="#log-for-raspberry-pi-client">17 Log for Raspberry Pi Client</a></h1>
<pre><code>
$ cd ~/go
$ mkdir -p src/mynewt.apache.org
$ cd src/mynewt.apache.org/
$ git clone https://github.com/apache/mynewt-newtmgr
$ mv mynewt-newtmgr newtmgr
$ cd newtmgr/newtmgr
$ export GO111MODULE=on
$ go build


$ cd ~/go/src/mynewt.apache.org/newtmgr/newtmgr
$ sudo ./newtmgr conn add mybleprph type=ble connstring=&quot;peer_name=pinetime&quot;
Connection profile mybleprph successfully added

$ sudo ./newtmgr image list -c mybleprph --loglevel debug
DEBU[2020-04-29 08:23:56.54] Using connection profile: name=mybleprph type=ble connstring=peer_name=pinetime
DEBU[2020-04-29 08:23:56.701] Connecting to peer
DEBU[2020-04-29 08:23:56.773] Exchanging MTU
DEBU[2020-04-29 08:23:56.822] Connecting to peer
DEBU[2020-04-29 08:23:56.907] Exchanging MTU
DEBU[2020-04-29 08:23:56.922] Exchanged MTU; ATT MTU = 256
DEBU[2020-04-29 08:23:56.922] Discovering profile
DEBU[2020-04-29 08:23:57.176] Subscribing to NMP response characteristic
DEBU[2020-04-29 08:23:57.191] {add-nmp-listener} [bll_sesn.go:392] seq=66
DEBU[2020-04-29 08:23:57.191] Encoded &amp;{NmpBase:{hdr:{Op:0 Flags:0 Len:0 Group:1 Seq:66 Id:0}}} to:
00000000  a0                                                |.|
DEBU[2020-04-29 08:23:57.191] Encoded:
00000000  00 00 00 01 00 01 42 00  a0                       |......B..|
DEBU[2020-04-29 08:23:57.191] Tx NMP request: 00000000  00 00 00 01 00 01 42 00  a0                       |......B..|
DEBU[2020-04-29 08:23:57.213] rx nmp response: 00000000  01 00 00 86 00 01 42 00  bf 66 69 6d 61 67 65 73  |......B..fimages|
00000010  9f bf 64 73 6c 6f 74 00  67 76 65 72 73 69 6f 6e  |..dslot.gversion|
00000020  65 31 2e 30 2e 30 64 68  61 73 68 58 20 ea b2 88  |e1.0.0dhashX ...|
00000030  69 47 a1 df 6f 85 04 63  60 1f 3d ad 40 94 11 d7  |iG..o..c`.=.@...|
00000040  ea 21 85 5e b0 a7 0e 96  57 32 25 8c 92 68 62 6f  |.!.^....W2%..hbo|
00000050  6f 74 61 62 6c 65 f5 67  70 65 6e 64 69 6e 67 f4  |otable.gpending.|
00000060  69 63 6f 6e 66 69 72 6d  65 64 f5 66 61 63 74 69  |iconfirmed.facti|
00000070  76 65 f5 69 70 65 72 6d  61 6e 65 6e 74 f4 ff ff  |ve.ipermanent...|
00000080  6b 73 70 6c 69 74 53 74  61 74 75 73 00 ff        |ksplitStatus..|
DEBU[2020-04-29 08:23:57.214] Received nmp rsp: &amp;{NmpBase:{hdr:{Op:1 Flags:0 Len:134 Group:1 Seq:66 Id:0}} Rc:0 Images:[{NmpBase:{hdr:{Op:0 Flags:0 Len:0 Group:0 Seq:0 Id:0}} Image:0 Slot:0 Version:1.0.0 Hash:[234 178 136 105 71 161 223 111 133 4 99 96 31 61 173 64 148 17 215 234 33 133 94 176 167 14 150 87 50 37 140 146] Bootable:true Pending:false Confirmed:true Active:true Permanent:false}] SplitStatus:N/A}
DEBU[2020-04-29 08:23:57.214] {remove-nmp-listener} [bll_sesn.go:392] seq=66
Images:
 image=0 slot=0
    version: 1.0.0
    bootable: true
    flags: active confirmed
    hash: eab2886947a1df6f850463601f3dad409411d7ea21855eb0a70e965732258c92
Split status: N/A (0)</code></pre><h1 id="further-reading" class="section-header"><a href="#further-reading">18 Further Reading</a></h1>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>

    
</body>
</html>