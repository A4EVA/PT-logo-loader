<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Configure Mynewt for SPI Flash on PineTime Smart Watch (nRF52)</title>

    
    <!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<!-- TODO -->
<meta property="og:image" content="https://lupyuen.github.io/images/spiflash-config.png">
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Configure Mynewt for SPI Flash on PineTime Smart Watch (nRF52)</h1>
    <nav id="TOC"><ul>
<li><a href="#syscfgyml-configure-pins-for-spi-port">1 <code>syscfg.yml:</code> Configure pins for SPI Port</a><ul></ul></li>
<li><a href="#syscfgyml-configure-flash-interface">2 <code>syscfg.yml:</code> Configure flash interface</a><ul></ul></li>
<li><a href="#syscfgyml-configure-flash-timings">3 <code>syscfg.yml:</code> Configure flash timings</a><ul></ul></li>
<li><a href="#hal_bspc-include-spiflashh">4 <code>hal_bsp.c:</code> Include <code>spiflash.h</code></a><ul></ul></li>
<li><a href="#hal_bspc-define-internal-and-external-flash-devices">5 <code>hal_bsp.c:</code> Define internal and external flash devices</a><ul></ul></li>
<li><a href="#hal_bspc-access-flash-devices-by-id">6 <code>hal_bsp.c:</code> Access flash devices by ID</a><ul></ul></li>
<li><a href="#pkgyml-add-spiflash-driver">7 <code>pkg.yml:</code> Add <code>spiflash</code> driver</a><ul></ul></li>
<li><a href="#test-spi-flash">8 Test SPI Flash</a><ul></ul></li>
<li><a href="#spi-flash-test-output">9 SPI Flash Test Output</a><ul></ul></li>
<li><a href="#spi-flash-benchmark">10 SPI Flash Benchmark</a><ul></ul></li>
<li><a href="#debugging-with-mcuboot">11 Debugging with MCUBoot</a><ul></ul></li>
<li><a href="#switching-mcuboot-to-stub-bootloader">12 Switching MCUBoot to Stub Bootloader</a><ul></ul></li>
<li><a href="#inside-the-spi-flash-driver">13 Inside The SPI Flash Driver</a><ul></ul></li>
<li><a href="#further-reading">14 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/spiflash-config.png" alt="Configure Mynewt for SPI Flash on PineTime Smart Watch (nRF52)" /></p>
<p><a href="https://lupyuen.github.io/images/spiflash-config.png"><em>Larger image here</em></a></p>
<p>There's one thing truly remarkable about the <a href="https://mynewt.apache.org/"><strong>Apache Mynewt</strong></a> embedded operating system... <strong>Almost any feature may be switched on by editing a configuration file!</strong></p>
<p>Today we'll learn to configure Mynewt OS to enable access to <strong>SPI Flash Memory</strong> on <a href="https://wiki.pine64.org/index.php/PineTime"><strong>PineTime Smart Watch</strong></a>... Just by editing two configuration files (<a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a> and <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/pkg.yml"><code>pkg.yml</code></a>), and making some minor code changes (<a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c"><code>hal_bsp.c</code></a>).</p>
<p>These steps will work for any Nordic nRF52 device, and probably STM32 devices too (<a href="https://lupyuen.github.io/images/spiflash-config.png">see diagram above</a>)...</p>
<ol>
<li>
<p><strong>Configure pins for SPI Port</strong> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a></p>
</li>
<li>
<p><strong>Configure flash interface</strong> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a></p>
</li>
<li>
<p><strong>Configure flash timings</strong> in<a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a></p>
</li>
<li>
<p><strong>Include <code>spiflash.h</code></strong> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c"><code>hal_bsp.c</code></a></p>
</li>
<li>
<p><strong>Define internal and external flash devices</strong> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c"><code>hal_bsp.c</code></a></p>
</li>
<li>
<p><strong>Access flash devices by ID</strong> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c"><code>hal_bsp.c</code></a></p>
</li>
<li>
<p><strong>Add <code>spiflash</code> driver</strong> to <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/pkg.yml"><code>pkg.yml</code></a></p>
</li>
</ol>
<p>Read on for the details...</p>
<p><img src="https://lupyuen.github.io/images/spiflash-config1.png" alt="syscfg.yml: Configuration for Board Support Package" /></p>
<p><em><code>syscfg.yml</code>: Configuration for Board Support Package</em></p>
<h1 id="syscfgyml-configure-pins-for-spi-port" class="section-header"><a href="#syscfgyml-configure-pins-for-spi-port">1 <code>syscfg.yml:</code> Configure pins for SPI Port</a></h1>
<p>The first configuration file we'll edit is <code>syscfg.yml</code> from Mynewt's Board Support Package. For PineTime, this file is located at...</p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>hw/bsp/nrf52/syscfg.yml</code></a></p>
<p>Let's add the PineTime SPI settings according to the <a href="https://wiki.pine64.org/index.php/PineTime">PineTime Wiki</a>: <a href="http://files.pine64.org/doc/PineTime/PineTime%20Port%20Assignment%20rev1.0.pdf">PineTime Port Assignment</a>...</p>
<table><thead><tr><th align="left">nRF52 Pin    </th><th align="left">Function</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="left"><code>P0.02</code></td><td align="left"><code>SPI-SCK, LCD_SCK</code></td><td align="left">SPI Clock</td></tr>
<tr><td align="left"><code>P0.03</code></td><td align="left"><code>SPI-MOSI, LCD_SDI</code>    </td><td align="left">SPI MOSI (master to slave)</td></tr>
<tr><td align="left"><code>P0.04</code></td><td align="left"><code>SPI-MISO</code></td><td align="left">SPI MISO (slave to master)</td></tr>
<tr><td align="left"><code>P0.05</code></td><td align="left"><code>SPI-CE# (SPI-NOR)</code></td><td align="left">SPI Chip Select<br><br></td></tr>
</tbody></table>
<p>Here's how it looks in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a>...</p>
<pre><code class="language-yaml">syscfg.vals:
    ...
    # Default Pins for Peripherals
    # Defined in http://files.pine64.org/doc/PineTime/PineTime%20Port%20Assignment%20rev1.0.pdf

    # SPI port 0 connected to ST7789 display and XT25F32B flash
    SPI_0_MASTER_PIN_SCK:  2  # P0.02/AIN0: SPI-SCK, LCD_SCK    SPI clock for display and flash
    SPI_0_MASTER_PIN_MOSI: 3  # P0.03/AIN1: SPI-MOSI, LCD_SDI   SPI MOSI for display and flash
    SPI_0_MASTER_PIN_MISO: 4  # P0.04/AIN2: SPI-MISO            SPI MISO for flash only
    ...
</code></pre>
<p>For pin numbers on nRF52, we may drop the <code>P0</code> prefix and write <code>P02.02</code> as <code>2</code>.</p>
<p>We'll add SPI Chip Select (<code>Pin 5</code>) in a while.</p>
<h1 id="syscfgyml-configure-flash-interface" class="section-header"><a href="#syscfgyml-configure-flash-interface">2 <code>syscfg.yml:</code> Configure flash interface</a></h1>
<p>Now we'll edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a> to tell Mynewt how to access our Flash Memory.  From the <a href="https://wiki.pine64.org/index.php/PineTime">PineTime Wiki</a>...</p>
<blockquote>
<p><strong>SPI Flash information:</strong> 
<a href="https://www.elnec.com/en/device/XTX/XT25F32B+%28QuadSPI%29+%5BSOP8-200%5D/">XTX XT25F32B</a> 32 Mb (4 MB) SPI NOR Flash <br><br>
Data sheets for this part are hard to find but it acts similar to other QuadSPI SPI NOR Flash such as <a href="https://www.macronix.com/Lists/Datasheet/Attachments/7426/MX25L3233F,%203V,%2032Mb,%20v1.6.pdf">Macronix</a> 32 Mb (4 MB) SPI NOR Flash <br><br>
IDs for XT25F32B are: <strong>Manufacturer (<code>0x0b</code>)</strong>, Device (<code>0x15</code>), <strong>Memory Type (<code>0x40</code>)</strong>, <strong>Density (<code>0x16</code>)</strong></p>
</blockquote>
<p>Confused about <code>MB</code> and <code>Mb</code>? <code>MB</code> stands for Mega Byte (roughly a million bytes), whereas <code>Mb</code> stands for Mega Bit (roughly a million bits). Divide <code>Mb</code> by 8 to get <code>MB</code>.</p>
<p>We don't have the datasheet for <a href="https://www.elnec.com/en/device/XTX/XT25F32B+%28QuadSPI%29+%5BSOP8-200%5D/">XT25F32B</a> Flash Memory... But fortunately the <a href="https://en.wikipedia.org/wiki/Common_Flash_Memory_Interface">JEDEC IDs</a> for Manufacturer, Memory Type and Density (Capacity) are all that we need for <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a>...</p>
<pre><code class="language-yaml">syscfg.vals:
    ...
    # SPI Flash
    # XTX XT25F32B 32 Mb (4 MB) SPI NOR Flash (similar to QuadSPI SPI NOR Flash like Macronix 32 Mb (4 MB) MX25L3233F)
    # manufacturer (0x0b), device (0x15), memory type (0x40), density (0x16)
    # Settings below are documented at https://github.com/apache/mynewt-core/blob/master/hw/drivers/flash/spiflash/syscfg.yml

    SPIFLASH:               1   # Enable SPI Flash
    SPIFLASH_SPI_NUM:       0   # SPI Interface 0
    SPIFLASH_SPI_CS_PIN:    5   # SPI interface CS pin: P0.05/AIN3, SPI-CE# (SPI-NOR)
    SPIFLASH_BAUDRATE:      8000    # Requested baudrate, 8000 is the fastest baudrate supported by nRF52832
    SPIFLASH_MANUFACTURER:  0x0B    # Expected SpiFlash manufacturer as read by Read JEDEC ID command 9FH
    SPIFLASH_MEMORY_TYPE:   0x40    # Expected SpiFlash memory type as read by Read JEDEC ID command 9FH
    SPIFLASH_MEMORY_CAPACITY: 0x16  # Expected SpiFlash memory capactity as read by Read JEDEC ID command 9FH (2 ^ 0x16 = 32 Mb)
    SPIFLASH_SECTOR_COUNT:  1024    # Number of sectors: 1024 sectors of 4 KB each
    SPIFLASH_SECTOR_SIZE:   4094    # Number of bytes that can be erased at a time: 4 KB sector size
    SPIFLASH_PAGE_SIZE:     256     # TODO Number of bytes that can be written at a time
    ...
</code></pre>
<p>The JEDEC Device ID (<code>0x15</code>) is not used.</p>
<p><code>SPIFLASH_SECTOR_COUNT</code> and <code>SPIFLASH_SECTOR_SIZE</code> were copied from <a href="https://www.macronix.com/Lists/Datasheet/Attachments/7426/MX25L3233F,%203V,%2032Mb,%20v1.6.pdf">Macronix MX25L3233F</a> since it's similar to our XT25F32B.</p>
<p><code>SPIFLASH_PAGE_SIZE</code> was copied from another Mynewt configuration: <a href="https://github.com/apache/mynewt-core/blob/master/hw/bsp/black_vet6/syscfg.yml"><code>black_vet6</code></a></p>
<h1 id="syscfgyml-configure-flash-timings" class="section-header"><a href="#syscfgyml-configure-flash-timings">3 <code>syscfg.yml:</code> Configure flash timings</a></h1>
<p>Finally we edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/syscfg.yml"><code>syscfg.yml</code></a> to tell Mynewt the timing characteristics of our Flash Memory...</p>
<pre><code class="language-yaml">syscfg.vals:
    ...
    # Copied from https://github.com/apache/mynewt-core/blob/master/hw/bsp/black_vet6/syscfg.yml
    SPIFLASH_TBP1_TYPICAL:  20      # Byte program time (first byte) (us)
    SPIFLASH_TBP1_MAXIMUM:  50      # Maximum byte program time (first byte) (us)
    SPIFLASH_TPP_TYPICAL:   700     # Page program time (us)
    SPIFLASH_TPP_MAXIMUM:   3000    # Maximum page program time (us)
    SPIFLASH_TSE_TYPICAL:   30000   # Sector erase time (4KB) (us)
    SPIFLASH_TSE_MAXIMUM:   400000  # Maximum sector erase time (us)
    SPIFLASH_TBE1_TYPICAL:  120000  # Block erase time (32KB) (us)
    SPIFLASH_TBE1_MAXIMUM:  800000  # Maximum block erase time (32KB) (us)
    SPIFLASH_TBE2_TYPICAL:  150000  # Block erase time (64KB) (us)
    SPIFLASH_TBE2_MAXIMUM:  1000000 # Maximum block erase time (64KB) (us)
    SPIFLASH_TCE_TYPICAL:   3000000 # Chip erase time (us)
    SPIFLASH_TCE_MAXIMUM:   10000000 # Maximum chip erase time (us)
    ...
</code></pre>
<p>If we have the Flash Memory Datasheet, fill in the numbers from the datasheet.</p>
<p>The above settings were copied from another Mynewt configuration: <a href="https://github.com/apache/mynewt-core/blob/master/hw/bsp/black_vet6/syscfg.yml"><code>black_vet6</code></a></p>
<p><img src="https://lupyuen.github.io/images/spiflash-config2.png" alt="hal_bsp.c: Code for Board Support Package" /></p>
<p><em><code>hal_bsp.c</code>: Code for Board Support Package</em> </p>
<h1 id="hal_bspc-include-spiflashh" class="section-header"><a href="#hal_bspc-include-spiflashh">4 <code>hal_bsp.c:</code> Include <code>spiflash.h</code></a></h1>
<p>TODO</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c</p>
<pre><code class="language-c">#if MYNEWT_VAL(SPIFLASH)  //  If External SPI Flash exists...
#include &lt;spiflash/spiflash.h&gt;
#endif  //  MYNEWT_VAL(SPIFLASH)
</code></pre>
<h1 id="hal_bspc-define-internal-and-external-flash-devices" class="section-header"><a href="#hal_bspc-define-internal-and-external-flash-devices">5 <code>hal_bsp.c:</code> Define internal and external flash devices</a></h1>
<p>TODO</p>
<p>Internal Flash ROM,
External SPI Flash</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c</p>
<pre><code class="language-c">/// Array of Flash Devices
static const struct hal_flash *flash_devs[] = {
    [0] = &amp;nrf52k_flash_dev,  //  Internal Flash ROM
#if MYNEWT_VAL(SPIFLASH)      //  If External SPI Flash exists...
    [1] = &amp;spiflash_dev.hal,  //  External SPI Flash
#endif                        //  MYNEWT_VAL(SPIFLASH)
};
</code></pre>
<h1 id="hal_bspc-access-flash-devices-by-id" class="section-header"><a href="#hal_bspc-access-flash-devices-by-id">6 <code>hal_bsp.c:</code> Access flash devices by ID</a></h1>
<p>0 for Internal Flash ROM,
1 for External SPI Flash</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/src/hal_bsp.c</p>
<pre><code class="language-c">/// Return the Flash Device for the ID. 0 for Internal Flash ROM, 1 for External SPI Flash
const struct hal_flash *
hal_bsp_flash_dev(uint8_t id)
{
    if (id &gt;= ARRAY_SIZE(flash_devs)) {
        return NULL;
    }
    return flash_devs[id];
}
</code></pre>
<p><img src="https://lupyuen.github.io/images/spiflash-config3.png" alt="pkg.yml: Drivers for Board Support Package`" /></p>
<p><em><code>pkg.yml</code>: Drivers for Board Support Package</em></p>
<h1 id="pkgyml-add-spiflash-driver" class="section-header"><a href="#pkgyml-add-spiflash-driver">7 <code>pkg.yml:</code> Add <code>spiflash</code> driver</a></h1>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/hw/bsp/nrf52/pkg.yml</p>
<pre><code class="language-yaml">pkg.deps:
    ...
    - &quot;@apache-mynewt-core/hw/drivers/flash/spiflash&quot;  # SPI Flash Driver
</code></pre>
<h1 id="test-spi-flash" class="section-header"><a href="#test-spi-flash">8 Test SPI Flash</a></h1>
<p>TODO</p>
<p>https://github.com/lupyuen/pinetime-rust-mynewt/blob/ota2/apps/my_sensor_app/src/flash_test.c</p>
<p>Based on https://github.com/apache/mynewt-core/blob/master/test/flash_test/src/flash_test.c</p>
<pre><code class="language-c">////////////////////
//  Dump Sector Map

//  Dump sector map for internal flash ROM
map_cmd(0) ||

//  Dump sector map for external SPI flash
map_cmd(1) ||

////////////////////////////////
//  Read Flash: Before erasing
//  flash &lt;flash-id&gt; read &lt;offset&gt; &lt;size&gt; -- reads bytes from flash        

//  Read internal flash ROM
flash_cmd(READ_COMMAND, 0, 0x0, 32) ||

//  Read external SPI flash
flash_cmd(READ_COMMAND, 1, 0x0, 32) ||

/////////////////////////////////////
//  Erase Flash: Set all bits to 1
//  flash &lt;flash-id&gt; erase &lt;offset&gt; &lt;size&gt; -- erases flash

//  Erase external SPI flash
flash_cmd(ERASE_COMMAND, 1, 0x0, 32) ||

////////////////////////////////////////
//  Read Flash: Shows all bits set to 1
//  flash &lt;flash-id&gt; read &lt;offset&gt; &lt;size&gt; -- reads bytes from flash        

//  Read internal flash ROM
flash_cmd(READ_COMMAND, 0, 0x0, 32) ||

//  Read external SPI flash
flash_cmd(READ_COMMAND, 1, 0x0, 32) ||

//////////////////////////////////////////////
//  Write Flash: Write 0x01, 0x02, 0x03, ... (Must erase before writing)
//  flash &lt;flash-id&gt; write &lt;offset&gt; &lt;size&gt; -- writes incrementing data pattern 0-8 to flash

//  Write external SPI flash
flash_cmd(WRITE_COMMAND, 1, 0x0, 32) ||

////////////////////////////////////////////
//  Read Flash: Shows 0x01, 0x02, 0x03, ...
//  flash &lt;flash-id&gt; read &lt;offset&gt; &lt;size&gt; -- reads bytes from flash        

//  Read internal flash ROM
flash_cmd(READ_COMMAND, 0, 0x0, 32) ||

//  Read external SPI flash
flash_cmd(READ_COMMAND, 1, 0x0, 32) ||

//////////////////////
//  Test Flash Speed
//  flash_speed &lt;flash_id&gt; &lt;addr&gt; &lt;rd_sz&gt;|range [move]
//  range=0 for size mode, range=1 for range mode, move=1 for move

//  Internal flash ROM, size mode, no move
//  speed_cmd(0, 0x0, 32, 0, 0) ||

//  External SPI flash, size mode, no move
//  speed_cmd(1, 0x0, 32, 0, 0) ||

//  Internal flash ROM, range mode, no move
//  speed_cmd(0, 0x0, 0, 1, 0) ||

//  External SPI flash, range mode, no move
//  speed_cmd(1, 0x0, 0, 1, 0) ||
0
</code></pre>
<h1 id="spi-flash-test-output" class="section-header"><a href="#spi-flash-test-output">9 SPI Flash Test Output</a></h1>
<p>TODO</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Testing</span> <span class="ident">flash</span>...
<span class="ident">Read</span> <span class="ident">Internal</span> <span class="ident">Flash</span> <span class="ident">ROM</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x20</span> <span class="number">0xd9</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0008</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x37</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Read</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x01</span> <span class="number">0x02</span> <span class="number">0x03</span> <span class="number">0x04</span> <span class="number">0x05</span> <span class="number">0x06</span> <span class="number">0x07</span> <span class="number">0x08</span> 
  <span class="number">0x0008</span>: <span class="number">0x09</span> <span class="number">0x0a</span> <span class="number">0x0b</span> <span class="number">0x0c</span> <span class="number">0x0d</span> <span class="number">0x0e</span> <span class="number">0x0f</span> <span class="number">0x10</span> 
  <span class="number">0x0010</span>: <span class="number">0x11</span> <span class="number">0x12</span> <span class="number">0x13</span> <span class="number">0x14</span> <span class="number">0x15</span> <span class="number">0x16</span> <span class="number">0x17</span> <span class="number">0x18</span> 
  <span class="number">0x0018</span>: <span class="number">0x19</span> <span class="number">0x1a</span> <span class="number">0x1b</span> <span class="number">0x1c</span> <span class="number">0x1d</span> <span class="number">0x1e</span> <span class="number">0x1f</span> <span class="number">0x20</span> 
<span class="ident">Erase</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Erase</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
<span class="macro">Done</span><span class="macro">!</span>
<span class="ident">Read</span> <span class="ident">Internal</span> <span class="ident">Flash</span> <span class="ident">ROM</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x20</span> <span class="number">0xd9</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0008</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x37</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Read</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> 
  <span class="number">0x0008</span>: <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> 
  <span class="number">0x0010</span>: <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> 
  <span class="number">0x0018</span>: <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> <span class="number">0xff</span> 
<span class="ident">Write</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Write</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
<span class="macro">Done</span><span class="macro">!</span>
<span class="ident">Read</span> <span class="ident">Internal</span> <span class="ident">Flash</span> <span class="ident">ROM</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x20</span> <span class="number">0xd9</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0008</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x37</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Read</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x01</span> <span class="number">0x02</span> <span class="number">0x03</span> <span class="number">0x04</span> <span class="number">0x05</span> <span class="number">0x06</span> <span class="number">0x07</span> <span class="number">0x08</span> 
  <span class="number">0x0008</span>: <span class="number">0x09</span> <span class="number">0x0a</span> <span class="number">0x0b</span> <span class="number">0x0c</span> <span class="number">0x0d</span> <span class="number">0x0e</span> <span class="number">0x0f</span> <span class="number">0x10</span> 
  <span class="number">0x0010</span>: <span class="number">0x11</span> <span class="number">0x12</span> <span class="number">0x13</span> <span class="number">0x14</span> <span class="number">0x15</span> <span class="number">0x16</span> <span class="number">0x17</span> <span class="number">0x18</span> 
  <span class="number">0x0018</span>: <span class="number">0x19</span> <span class="number">0x1a</span> <span class="number">0x1b</span> <span class="number">0x1c</span> <span class="number">0x1d</span> <span class="number">0x1e</span> <span class="number">0x1f</span> <span class="number">0x20</span> 
<span class="ident">Flash</span> <span class="ident">OK</span>

<span class="ident">Flash</span> <span class="ident">Sector</span> <span class="ident">Map</span>:
<span class="ident">Flash</span> <span class="number">0</span> <span class="ident">at</span> <span class="number">0x0</span> <span class="ident">size</span> <span class="number">0x80000</span> <span class="ident">with</span> <span class="number">128</span> <span class="ident">sectors</span>, <span class="ident">alignment</span> <span class="ident">req</span> <span class="number">1</span> <span class="ident">bytes</span>
  <span class="number">0</span>:   <span class="number">1000</span>
  <span class="number">1</span>:   <span class="number">1000</span>
  <span class="number">2</span>:   <span class="number">1000</span>
  ...
  <span class="number">127</span>: <span class="number">1000</span>

<span class="ident">Flash</span> <span class="number">1</span> <span class="ident">at</span> <span class="number">0x0</span> <span class="ident">size</span> <span class="number">0x3ff800</span> <span class="ident">with</span> <span class="number">1024</span> <span class="ident">sectors</span>, <span class="ident">alignment</span> <span class="ident">req</span> <span class="number">1</span> <span class="ident">bytes</span>
  <span class="number">0</span>:    <span class="ident">ffe</span>
  <span class="number">1</span>:    <span class="ident">ffe</span>
  <span class="number">2</span>:    <span class="ident">ffe</span>
  ...  
  <span class="number">1023</span>: <span class="ident">ffe</span></pre></div>
<h1 id="spi-flash-benchmark" class="section-header"><a href="#spi-flash-benchmark">10 SPI Flash Benchmark</a></h1>
<p>TODO</p>
<h1 id="debugging-with-mcuboot" class="section-header"><a href="#debugging-with-mcuboot">11 Debugging with MCUBoot</a></h1>
<p>If we're using the MCUBoot Bootloader (like on PineTime), debugging and testing SPI Flash can be somewhat challenging.</p>
<p>Remember that we added the SPI Flash Driver to the Board Support Package?</p>
<p>The Board Support Package is used by <em>both</em> the MCUBoot Bootloader as well as the Application Firmware. Which means that the SPI Flash Driver is loaded when MCUBoot starts.</p>
<p><em>What happens if the SPI Flash Driver is configured incorrectly?</em></p>
<p>MCUBoot may crash... Before starting the Application Firmware! (This happened to me)</p>
<p>Hence for debugging and testing SPI Flash, I strongly recommend switching the Bootloader to a simpler one that doesn't require any drivers: the Stub Bootloader.</p>
<p>This will enable us to debug and test SPI Flash with our Application Firmware, before using it with MCUBoot.</p>
<p>Also MCUBoot expects the Application Firmware Image to start with the MCUBoot Image Header. When the GDB debugger flashes the Firmware ELF File into ROM, the Image Header is empty. So MCUBoot won't work start the Application Firmware properly when the debugger is running. Switching MCUBoot to the Stub Bootloader will solve this.</p>
<h1 id="switching-mcuboot-to-stub-bootloader" class="section-header"><a href="#switching-mcuboot-to-stub-bootloader">12 Switching MCUBoot to Stub Bootloader</a></h1>
<p>TODO</p>
<h1 id="inside-the-spi-flash-driver" class="section-header"><a href="#inside-the-spi-flash-driver">13 Inside The SPI Flash Driver</a></h1>
<p>TODO</p>
<p>Based on https://github.com/apache/mynewt-core/blob/master/hw/bsp/black_vet6/syscfg.yml</p>
<p>https://www.winbond.com/resource-files/w25q16jv%20spi%20revh%2004082019%20plus.pdf</p>
<h1 id="further-reading" class="section-header"><a href="#further-reading">14 Further Reading</a></h1>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>

    
</body>
</html>